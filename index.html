<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>HACCP Pro V1</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ‚îÄ‚îÄ RESET ‚îÄ‚îÄ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#f0f2f5;color:#1a1a2e;line-height:1.5;min-height:100vh;overflow-x:hidden}
input,select,textarea,button{font-family:inherit;font-size:inherit}
a{color:inherit;text-decoration:none}

/* ‚îÄ‚îÄ VARIABLES ‚îÄ‚îÄ */
:root{
  --primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#dbeafe;--primary-bg:#eff6ff;
  --success:#059669;--success-bg:#d1fae5;--warning:#d97706;--warning-bg:#fef3c7;
  --danger:#dc2626;--danger-bg:#fee2e2;--gray:#6b7280;--gray-light:#f3f4f6;--gray-border:#e5e7eb;
  --radius:10px;--shadow:0 1px 3px rgba(0,0,0,0.1);--shadow-md:0 4px 12px rgba(0,0,0,0.1);
  --sidebar-w:260px;--header-h:60px;
}

/* ‚îÄ‚îÄ AUTH PAGE ‚îÄ‚îÄ */
.auth-wrapper{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1e3a5f 0%,#2563eb 100%)}
.auth-card{background:#fff;border-radius:16px;padding:40px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
.auth-logo{text-align:center;margin-bottom:24px}
.auth-logo h1{font-size:28px;color:#1a1a2e;font-weight:800}
.auth-logo p{color:var(--gray);font-size:14px;margin-top:4px}
.auth-tabs{display:flex;gap:4px;background:var(--gray-light);border-radius:8px;padding:4px;margin-bottom:24px}
.auth-tab{flex:1;padding:10px;text-align:center;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;border:none;background:none;color:var(--gray);transition:.2s}
.auth-tab.active{background:#fff;color:var(--primary);box-shadow:var(--shadow)}

/* ‚îÄ‚îÄ CHANGE PASSWORD MODAL ‚îÄ‚îÄ */
.pwd-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
.pwd-card{background:#fff;border-radius:16px;padding:40px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.pwd-card h2{font-size:22px;margin-bottom:8px;color:#1a1a2e}
.pwd-card p{color:var(--gray);margin-bottom:20px;font-size:14px}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-group{margin-bottom:16px}
.form-label{display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px}
.form-label .req{color:var(--danger)}
.form-input,.form-select,.form-textarea{width:100%;padding:10px 14px;border:2px solid var(--gray-border);border-radius:8px;font-size:15px;transition:.2s;background:#fff;outline:none}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
.form-textarea{resize:vertical;min-height:60px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-hint{font-size:12px;color:var(--gray);margin-top:4px}
.form-error{font-size:12px;color:var(--danger);margin-top:4px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 20px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;border:none;transition:.2s;min-height:44px}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-ghost{background:transparent;color:var(--gray);border:1px solid var(--gray-border)}.btn-ghost:hover{background:var(--gray-light)}
.btn-sm{padding:6px 12px;font-size:13px;min-height:36px}
.btn-lg{padding:14px 28px;font-size:16px}
.btn-block{width:100%}
.btn:disabled{opacity:0.5;cursor:not-allowed}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app-layout{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-w);background:#fff;border-right:1px solid var(--gray-border);position:fixed;top:0;left:0;bottom:0;z-index:100;display:flex;flex-direction:column;transition:transform .3s}
.sidebar-header{padding:16px 20px;border-bottom:1px solid var(--gray-border)}
.sidebar-brand{display:flex;align-items:center;gap:10px}
.sidebar-brand h2{font-size:18px;color:var(--primary);font-weight:800}
.sidebar-brand span{font-size:24px}

/* Site selector */
.site-selector{padding:12px 16px;border-bottom:1px solid var(--gray-border)}
.site-selector select{width:100%;padding:8px 12px;border:2px solid var(--gray-border);border-radius:8px;font-size:13px;font-weight:600;background:#fff;cursor:pointer}
.site-selector select:focus{border-color:var(--primary)}

/* Nav */
.sidebar-nav{flex:1;overflow-y:auto;padding:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;color:#4b5563;transition:.15s;margin-bottom:2px}
.nav-item:hover{background:var(--gray-light);color:#1a1a2e}
.nav-item.active{background:var(--primary-bg);color:var(--primary);font-weight:600}
.nav-item .nav-icon{font-size:18px;width:24px;text-align:center}
.nav-section{font-size:11px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:1px;padding:16px 16px 6px;margin-top:4px}
.nav-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:11px;padding:2px 8px;border-radius:10px;font-weight:700}

/* User */
.sidebar-user{padding:12px 16px;border-top:1px solid var(--gray-border);display:flex;align-items:center;gap:10px}
.sidebar-user .avatar{width:36px;height:36px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--primary)}
.sidebar-user .user-info{flex:1;min-width:0}
.sidebar-user .user-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sidebar-user .user-role{font-size:11px;color:var(--gray)}

/* Main */
.main-content{margin-left:var(--sidebar-w);flex:1;min-height:100vh}
.main-header{height:var(--header-h);background:#fff;border-bottom:1px solid var(--gray-border);display:flex;align-items:center;padding:0 24px;position:sticky;top:0;z-index:50}
.main-header h1{font-size:18px;font-weight:700;color:#1a1a2e}
.main-header .header-sub{font-size:13px;color:var(--gray);margin-left:12px}
.burger{display:none;background:none;border:none;font-size:24px;cursor:pointer;padding:8px;margin-right:12px}
.main-body{padding:24px;max-width:1100px}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px;overflow:hidden}
.card-header{padding:16px 20px;font-weight:700;font-size:15px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--gray-border)}
.card-body{padding:20px}
.card-footer{padding:12px 20px;border-top:1px solid var(--gray-border);background:var(--gray-light)}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
.stat-card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border-left:4px solid var(--primary)}
.stat-card.success{border-left-color:var(--success)}
.stat-card.warning{border-left-color:var(--warning)}
.stat-card.danger{border-left-color:var(--danger)}
.site-overview-card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:16px;border-left:4px solid var(--primary);transition:transform .15s,box-shadow .15s;cursor:pointer}
.site-overview-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}
.site-overview-card .site-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.site-overview-card .site-card-title{font-size:16px;font-weight:700;color:#1a1a2e;display:flex;align-items:center;gap:8px}
.site-overview-card .site-card-badges{display:flex;gap:6px;flex-wrap:wrap}
.site-overview-card .mini-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.site-overview-card .mini-stat{text-align:center;padding:10px 6px;background:var(--gray-light);border-radius:8px}
.site-overview-card .mini-stat-value{font-size:20px;font-weight:800;color:#1a1a2e}
.site-overview-card .mini-stat-label{font-size:11px;color:var(--gray);margin-top:2px}
.site-overview-card .mini-stat.ok{background:#e8f5e9}
.site-overview-card .mini-stat.warn{background:#fff8e1}
.site-overview-card .mini-stat.bad{background:#fce4ec}
.global-stats-banner{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px}
.global-stat{background:#fff;border-radius:var(--radius);padding:16px 20px;box-shadow:var(--shadow);text-align:center}
.global-stat .gs-value{font-size:32px;font-weight:900;color:var(--primary)}
.global-stat .gs-label{font-size:12px;color:var(--gray);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.global-stat.gs-danger .gs-value{color:var(--danger)}
.global-stat.gs-warning .gs-value{color:var(--warning)}
.global-stat.gs-success .gs-value{color:var(--success)}
.stat-value{font-size:28px;font-weight:800;color:#1a1a2e}
.stat-label{font-size:13px;color:var(--gray);margin-top:4px}

/* ‚îÄ‚îÄ LISTS ‚îÄ‚îÄ */
.list-item{display:flex;align-items:center;gap:14px;padding:14px 16px;border-bottom:1px solid var(--gray-border);transition:.1s}
.list-item:last-child{border-bottom:none}
.list-item:hover{background:var(--gray-light)}
.list-icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.list-content{flex:1;min-width:0}
.list-title{font-weight:600;font-size:14px}
.list-sub{font-size:13px;color:var(--gray);margin-top:2px}
.list-actions{display:flex;gap:6px;flex-shrink:0}

/* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600}
.badge-green{background:var(--success-bg);color:var(--success)}
.badge-yellow{background:var(--warning-bg);color:var(--warning)}
.badge-red{background:var(--danger-bg);color:var(--danger)}
.badge-blue{background:var(--primary-light);color:var(--primary)}
.badge-gray{background:var(--gray-light);color:var(--gray)}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;gap:4px;background:var(--gray-light);border-radius:8px;padding:4px;margin-bottom:16px;overflow-x:auto}
.tab{padding:8px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:none;color:var(--gray);white-space:nowrap;transition:.2s}
.tab.active{background:#fff;color:var(--primary);box-shadow:var(--shadow)}

/* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
.filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.filter-btn{padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;border:1px solid var(--gray-border);background:#fff;color:var(--gray);transition:.2s}
.filter-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* ‚îÄ‚îÄ PHOTO BOX ‚îÄ‚îÄ */
.photo-box{border:2px dashed var(--gray-border);border-radius:var(--radius);padding:24px;text-align:center;cursor:pointer;transition:.2s;display:block;background:#fafbfc}
.photo-box:hover{border-color:var(--primary);background:var(--primary-bg)}
.photo-box .photo-icon{font-size:32px;margin-bottom:8px}
.photo-box .photo-text{font-size:14px;font-weight:600;color:#374151}
.photo-box .photo-hint{font-size:12px;color:var(--gray);margin-top:4px}
.photo-preview{max-width:100%;max-height:200px;border-radius:8px;margin-bottom:8px}
.photo-result{margin-top:8px;padding:10px;border-radius:8px;background:var(--success-bg);font-size:13px;color:var(--success)}

/* ‚îÄ‚îÄ SIGNATURE ‚îÄ‚îÄ */
.sig-canvas{width:100%;height:200px;border:2px solid var(--gray-border);border-radius:8px;cursor:crosshair;touch-action:none;background:#fff}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;opacity:0;pointer-events:none;transition:.2s}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal{background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
.modal-header{padding:20px;border-bottom:1px solid var(--gray-border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:18px;font-weight:700}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray);padding:4px}
.modal-body{padding:20px}
.modal-footer{padding:16px 20px;border-top:1px solid var(--gray-border);display:flex;justify-content:flex-end;gap:8px}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty{text-align:center;padding:40px 20px}
.empty-icon{font-size:48px;margin-bottom:12px}
.empty-title{font-size:16px;font-weight:700;color:#374151;margin-bottom:4px}
.empty-text{font-size:14px;color:var(--gray)}

/* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
.toggle{position:relative;width:48px;height:26px;cursor:pointer;display:inline-block}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--gray-border);border-radius:13px;transition:.2s}
.toggle-slider::before{content:'';position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;left:3px;top:3px;transition:.2s;box-shadow:var(--shadow)}
.toggle input:checked+.toggle-slider{background:var(--primary)}
.toggle input:checked+.toggle-slider::before{transform:translateX(22px)}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress{height:8px;background:var(--gray-light);border-radius:4px;overflow:hidden}
.progress-bar{height:100%;border-radius:4px;transition:.3s;background:var(--primary)}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading{display:inline-block;width:18px;height:18px;border:3px solid var(--gray-light);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.data-table{width:100%;border-collapse:collapse}
.data-table th{background:var(--gray-light);font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--gray);padding:10px 14px;text-align:left;border-bottom:2px solid var(--gray-border)}
.data-table td{padding:10px 14px;border-bottom:1px solid var(--gray-border);font-size:14px}
.data-table tr:hover td{background:var(--gray-light)}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .sidebar-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:99;display:none}
  .sidebar-backdrop.show{display:block}
  .main-content{margin-left:0}
  .burger{display:block}
  .main-body{padding:16px}
  .stats-grid{grid-template-columns:1fr 1fr}
  .form-row{grid-template-columns:1fr}
  .tabs{gap:2px}
  .tab{padding:6px 12px;font-size:12px}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr}
  .auth-card{padding:24px}
}

/* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
@media print{.sidebar,.main-header,.burger,.sidebar-backdrop{display:none!important}.main-content{margin-left:0!important}}
</style>
</head>
<body>
<div id="app"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh"><div class="loading" style="width:40px;height:40px;border-width:4px"></div></div></div>

<!-- MODAL CONTAINER -->
<div id="modalOverlay" class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal" id="modalContent"></div></div>

<!-- SIDEBAR BACKDROP (mobile) -->
<div id="sidebarBackdrop" class="sidebar-backdrop" onclick="toggleSidebar()"></div>

<script>
// =====================================================================
// HACCP PRO V1 ‚Äî APPLICATION JAVASCRIPT COMPL√àTE
// =====================================================================

// ‚îÄ‚îÄ CONFIG SUPABASE ‚îÄ‚îÄ
// IMPORTANT: Remplacez par vos propres cl√©s Supabase
var SB_URL = 'https://lqwdhbevylmgrrgkdoxn.supabase.co';
var SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd2RoYmV2eWxtZ3JyZ2tkb3huIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODU2MzksImV4cCI6MjA4NTk2MTYzOX0.YjglruiKzMAwlF0xje8zenidlYUXbyeYY4bAziL7FXU';

var sb;
try { sb = supabase.createClient(SB_URL, SB_KEY); } catch(e) { console.error('Supabase init error:', e); }

// ‚îÄ‚îÄ HELPER DOM ‚îÄ‚îÄ
function $(id) { return document.getElementById(id); }
function esc(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function fmtD(d) { if (!d) return '‚Äî'; try { return new Date(d).toLocaleDateString('fr-FR'); } catch(e) { return d; } }
function fmtDT(d) { if (!d) return '‚Äî'; try { return new Date(d).toLocaleString('fr-FR'); } catch(e) { return d; } }
function today() { return new Date().toISOString().split('T')[0]; }
function daysUntil(d) { return Math.ceil((new Date(d) - new Date(today())) / 86400000); }

// ‚îÄ‚îÄ APPLICATION STATE ‚îÄ‚îÄ
var S = {
  user: null,
  profile: null,
  page: 'dashboard',
  sites: [],
  currentSiteId: null,
  siteConfig: { equipment: [], products: [], suppliers: [], modules: [] },
  data: { temperatures: [], dlcs: [], lots: [], orders: [], consignes: [] },
  filter: 'all',
  adminTab: 'users',
  settingsTab: 'equipment',
  photoDlcData: null,
  photoLotData: null,
  sigData: null,
  sidebarOpen: false,
  loading: true
};

// ‚îÄ‚îÄ CURRENT SITE HELPER ‚îÄ‚îÄ
function currentSite() {
  return S.sites.find(function(s) { return s.id === S.currentSiteId; }) || null;
}

function isSuperAdmin() { return S.profile && S.profile.role === 'super_admin'; }
function isManager() { return S.profile && (S.profile.role === 'super_admin' || S.profile.role === 'manager'); }
function userName() { return S.profile ? (S.profile.full_name || S.profile.email) : 'Utilisateur'; }
function userInitials() { var n = userName(); return n.split(' ').map(function(w){return w[0]||'';}).join('').substring(0,2).toUpperCase(); }

function moduleEnabled(key) {
  var m = S.siteConfig.modules.find(function(mod) { return mod.module_key === key; });
  return m ? m.enabled : true;
}

// =====================================================================
// AUTH
// =====================================================================

async function checkAuth() {
  try {
    var sess = await sb.auth.getSession();
    if (sess.data.session) {
      S.user = sess.data.session.user;
      await loadProfile();
      return true;
    }
  } catch(e) { console.error('Auth check error:', e); }
  return false;
}

async function loadProfile() {
  if (!S.user) return;
  try {
    var r = await sb.from('profiles').select('*').eq('id', S.user.id).single();
    if (r.data) {
      S.profile = r.data;
    } else {
      // Profil pas encore cr√©√© (d√©lai trigger) ‚Äî retry apr√®s 1s
      await new Promise(function(resolve) { setTimeout(resolve, 1000); });
      var r2 = await sb.from('profiles').select('*').eq('id', S.user.id).single();
      if (r2.data) S.profile = r2.data;
      else console.error('Profil introuvable pour', S.user.id);
    }
  } catch(e) { console.error('Load profile error:', e); }
}

async function doLogin(email, pass) {
  var r = await sb.auth.signInWithPassword({ email: email, password: pass });
  if (r.error) throw r.error;
  S.user = r.data.user;
  await loadProfile();
  if (S.profile && S.profile.must_change_password) {
    renderChangePassword();
    return;
  }
  await initApp();
}

async function doRegister(email, pass, name) {
  var r = await sb.auth.signUp({
    email: email,
    password: pass,
    options: { data: { full_name: name } }
  });
  if (r.error) throw r.error;
  alert('Inscription r√©ussie ! V√©rifiez votre email pour confirmer votre compte, puis connectez-vous.');
}

async function doLogout() {
  await sb.auth.signOut();
  S.user = null;
  S.profile = null;
  S.sites = [];
  S.currentSiteId = null;
  render();
}

async function changePassword(newPass) {
  var r = await sb.auth.updateUser({ password: newPass });
  if (r.error) throw r.error;
  await sb.from('profiles').update({ must_change_password: false }).eq('id', S.user.id);
  S.profile.must_change_password = false;
  await initApp();
}

// Admin: create user with provisional password
async function createUser(email, tempPass, fullName, role) {
  // Sauvegarder la session super_admin actuelle
  var currentSession = await sb.auth.getSession();
  var savedToken = currentSession.data.session;

  // √âtape 1 : Cr√©er le compte Auth (role forc√© √† 'employee' par trigger)
  var r = await sb.auth.signUp({
    email: email,
    password: tempPass,
    options: { data: { full_name: fullName } }
  });
  if (r.error) throw r.error;
  var newUser = r.data.user;
  if (!newUser) throw new Error('Utilisateur non cr√©√©');

  // √âtape 2 : Restaurer la session super_admin (signUp auto-connecte le nouveau user)
  if (savedToken) {
    await sb.auth.setSession({ access_token: savedToken.access_token, refresh_token: savedToken.refresh_token });
  }

  // Attendre que le trigger cr√©e le profil
  await new Promise(function(resolve) { setTimeout(resolve, 1500); });

  // √âtape 3 : Promouvoir via RPC serveur (si pas employee)
  if (role && role !== 'employee') {
    var r2 = await sb.rpc('admin_set_user_role', { p_target_user_id: newUser.id, p_new_role: role });
    if (r2.error) throw r2.error;
  }

  // √âtape 4 : D√©sactiver must_change_password (le super_admin a choisi le mdp)
  await sb.from('profiles').update({ must_change_password: false }).eq('id', newUser.id);

  return newUser;
}

// =====================================================================
// DATA LOADING
// =====================================================================

async function loadSites() {
  if (!S.user) return;
  try {
    if (isSuperAdmin()) {
      var r = await sb.from('sites').select('*').order('name');
      S.sites = r.data || [];
    } else {
      var r = await sb.from('user_sites').select('site_id, site_role, sites(*)').eq('user_id', S.user.id);
      S.sites = (r.data || []).map(function(us) { var site = us.sites; site._role = us.site_role; return site; });
    }
    if (S.sites.length > 0 && !S.currentSiteId) {
      S.currentSiteId = S.sites[0].id;
    }
  } catch(e) { console.error('Load sites error:', e); }
}

async function loadSiteConfig() {
  if (!S.currentSiteId) return;
  try {
    var eq = await sb.from('site_equipment').select('*').eq('site_id', S.currentSiteId).eq('active', true).order('sort_order');
    S.siteConfig.equipment = eq.data || [];

    var pr = await sb.from('site_products').select('*').eq('site_id', S.currentSiteId).eq('active', true).order('sort_order');
    S.siteConfig.products = pr.data || [];

    var su = await sb.from('site_suppliers').select('*').eq('site_id', S.currentSiteId).eq('active', true).order('name');
    S.siteConfig.suppliers = su.data || [];

    var mo = await sb.from('site_modules').select('*').eq('site_id', S.currentSiteId);
    S.siteConfig.modules = mo.data || [];
  } catch(e) { console.error('Load config error:', e); }
}

async function loadSiteData() {
  if (!S.currentSiteId) return;
  var sid = S.currentSiteId;
  var todayStr = today();
  try {
    var t = await sb.from('temperatures').select('*').eq('site_id', sid).gte('recorded_at', todayStr + 'T00:00:00').order('recorded_at', {ascending:false});
    S.data.temperatures = t.data || [];

    var d = await sb.from('dlcs').select('*').eq('site_id', sid).order('dlc_date');
    S.data.dlcs = d.data || [];

    var l = await sb.from('lots').select('*').eq('site_id', sid).order('recorded_at', {ascending:false}).limit(50);
    S.data.lots = l.data || [];

    var o = await sb.from('orders').select('*').eq('site_id', sid).in('status', ['to_order','ordered']).order('ordered_at', {ascending:false});
    S.data.orders = o.data || [];

    var c = await sb.from('consignes').select('*').eq('site_id', sid).order('created_at', {ascending:false}).limit(20);
    S.data.consignes = c.data || [];
  } catch(e) { console.error('Load data error:', e); }
}

async function switchSite(siteId) {
  S.currentSiteId = siteId;
  await loadSiteConfig();
  await loadSiteData();
  render();
}

async function initApp() {
  S.loading = true;
  render();
  await loadSites();
  if (S.currentSiteId) {
    await loadSiteConfig();
    await loadSiteData();
  }
  S.loading = false;
  S.page = 'dashboard';
  render();
}

// =====================================================================
// CRUD OPERATIONS
// =====================================================================

// -- Temperatures --
async function addTemperature(type, refId, value, corrAction, corrNote) {
  var equip = type === 'equipment' ? S.siteConfig.equipment.find(function(e){return e.id===refId;}) : null;
  var prod = type === 'product' ? S.siteConfig.products.find(function(p){return p.id===refId;}) : null;
  var minT = equip ? equip.temp_min : (prod ? prod.temp_min : -999);
  var maxT = equip ? equip.temp_max : (prod ? prod.temp_max : 999);
  var conform = value >= minT && value <= maxT;
  var rec = {
    site_id: S.currentSiteId,
    record_type: type,
    equipment_id: type === 'equipment' ? refId : null,
    product_id: type === 'product' ? refId : null,
    value: parseFloat(value),
    is_conform: conform,
    corrective_action: corrAction || null,
    corrective_note: corrNote || null,
    recorded_by: S.user.id,
    recorded_by_name: userName(),
    signature_data: S.sigData || null
  };
  var r = await sb.from('temperatures').insert(rec);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

// -- DLC --
async function addDlc(productName, dlcDate, lotNumber, notes) {
  var rec = {
    site_id: S.currentSiteId,
    product_name: productName,
    dlc_date: dlcDate,
    lot_number: lotNumber || '',
    photo_data: S.photoDlcData || null,
    notes: notes || '',
    recorded_by: S.user.id,
    recorded_by_name: userName()
  };
  var r = await sb.from('dlcs').insert(rec);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  S.photoDlcData = null;
  await loadSiteData();
  render();
}

async function deleteDlc(id) {
  if (!confirm('Supprimer ce contr√¥le DLC ?')) return;
  var r = await sb.from('dlcs').delete().eq('id', id);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

async function updateDlcStatus(id, status) {
  var r = await sb.from('dlcs').update({ status: status }).eq('id', id);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

// -- Lots --
async function addLot(productName, lotNumber, supplierName, dlcDate, notes) {
  var rec = {
    site_id: S.currentSiteId,
    product_name: productName,
    lot_number: lotNumber,
    supplier_name: supplierName || '',
    dlc_date: dlcDate || null,
    photo_data: S.photoLotData || null,
    notes: notes || '',
    recorded_by: S.user.id,
    recorded_by_name: userName()
  };
  var r = await sb.from('lots').insert(rec);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  S.photoLotData = null;
  await loadSiteData();
  render();
}

async function deleteLot(id) {
  if (!confirm('Supprimer ce lot ?')) return;
  var r = await sb.from('lots').delete().eq('id', id);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

// -- Orders --
async function addOrder(productName, qty, unit, supplierName, notes) {
  var rec = {
    site_id: S.currentSiteId,
    product_name: productName,
    quantity: parseFloat(qty) || 1,
    unit: unit || 'unit√©',
    supplier_name: supplierName || '',
    notes: notes || '',
    status: 'to_order',
    ordered_by: S.user.id,
    ordered_by_name: userName()
  };
  var r = await sb.from('orders').insert(rec);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

async function updateOrderStatus(id, status) {
  var upd = { status: status };
  if (status === 'received') upd.received_at = new Date().toISOString();
  var r = await sb.from('orders').update(upd).eq('id', id);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

async function deleteOrder(id) {
  if (!confirm('Supprimer cette commande ?')) return;
  var r = await sb.from('orders').delete().eq('id', id);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

// -- Consignes --
async function addConsigne(message, priority) {
  var rec = {
    site_id: S.currentSiteId,
    message: message,
    priority: priority || 'normal',
    created_by: S.user.id,
    created_by_name: userName()
  };
  var r = await sb.from('consignes').insert(rec);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

async function deleteConsigne(id) {
  var r = await sb.from('consignes').delete().eq('id', id);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSiteData();
  render();
}

// =====================================================================
// SITE MANAGEMENT (Admin)
// =====================================================================

async function createSite(name, type, address, city, phone, email, agrement, responsable) {
  var r = await sb.rpc('create_site_with_defaults', { p_name: name, p_address: address || '', p_type: type || 'hotel' });
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  var siteId = r.data;
  // Update extra fields
  await sb.from('sites').update({ city:city||'', phone:phone||'', email:email||'', agrement:agrement||'', responsable:responsable||'' }).eq('id', siteId);
  await loadSites();
  S.currentSiteId = siteId;
  await loadSiteConfig();
  await loadSiteData();
  render();
  alert('Site cr√©√© avec succ√®s !');
}

async function updateSite(siteId, data) {
  await sb.from('sites').update(data).eq('id', siteId);
  await loadSites();
  render();
}

window.updateSiteConfig = async function(key, value) {
  if (!S.currentSiteId) return;
  var data = {};
  data[key] = value;
  await sb.from('sites').update(data).eq('id', S.currentSiteId);
  // Update local cache
  var site = S.sites.find(function(s){return s.id===S.currentSiteId;});
  if (site) site[key] = value;
  render();
};

async function deleteSite(siteId) {
  if (!confirm('ATTENTION : Supprimer ce site supprimera TOUTES ses donn√©es. Continuer ?')) return;
  if (!confirm('√ätes-vous vraiment s√ªr ?')) return;
  var r = await sb.from('sites').delete().eq('id', siteId);
  if (r.error) { alert('Erreur: ' + r.error.message); return; }
  await loadSites();
  if (S.currentSiteId === siteId) {
    S.currentSiteId = S.sites.length > 0 ? S.sites[0].id : null;
    if (S.currentSiteId) { await loadSiteConfig(); await loadSiteData(); }
  }
  render();
}

// =====================================================================
// EQUIPMENT / PRODUCT / SUPPLIER MANAGEMENT
// =====================================================================

async function addEquipment(name, type, tempMin, tempMax, emoji) {
  var maxSort = S.siteConfig.equipment.reduce(function(m,e){return Math.max(m,e.sort_order||0);},0);
  await sb.from('site_equipment').insert({ site_id:S.currentSiteId, name:name, type:type, temp_min:tempMin, temp_max:tempMax, emoji:emoji||'‚ùÑÔ∏è', sort_order:maxSort+1 });
  await loadSiteConfig(); render();
}

async function updateEquipment(id, data) {
  await sb.from('site_equipment').update(data).eq('id', id);
  await loadSiteConfig(); render();
}

async function deleteEquipment(id) {
  if (!confirm('D√©sactiver cet √©quipement ?')) return;
  await sb.from('site_equipment').update({active:false}).eq('id', id);
  await loadSiteConfig(); render();
}

async function addProduct(name, category, tempMin, tempMax, emoji) {
  var maxSort = S.siteConfig.products.reduce(function(m,p){return Math.max(m,p.sort_order||0);},0);
  await sb.from('site_products').insert({ site_id:S.currentSiteId, name:name, category:category, temp_min:tempMin, temp_max:tempMax, emoji:emoji||'üì¶', sort_order:maxSort+1 });
  await loadSiteConfig(); render();
}

async function deleteProduct(id) {
  if (!confirm('D√©sactiver ce produit ?')) return;
  await sb.from('site_products').update({active:false}).eq('id', id);
  await loadSiteConfig(); render();
}

async function addSupplier(name, phone, email) {
  await sb.from('site_suppliers').insert({ site_id:S.currentSiteId, name:name, phone:phone||'', email:email||'' });
  await loadSiteConfig(); render();
}

async function deleteSupplier(id) {
  if (!confirm('D√©sactiver ce fournisseur ?')) return;
  await sb.from('site_suppliers').update({active:false}).eq('id', id);
  await loadSiteConfig(); render();
}

// =====================================================================
// MODULE MANAGEMENT
// =====================================================================

async function toggleModule(moduleKey, enabled) {
  var existing = S.siteConfig.modules.find(function(m){return m.module_key===moduleKey;});
  if (existing) {
    await sb.from('site_modules').update({enabled:enabled}).eq('id', existing.id);
  } else {
    await sb.from('site_modules').insert({site_id:S.currentSiteId, module_key:moduleKey, enabled:enabled});
  }
  await loadSiteConfig(); render();
}

// =====================================================================
// USER MANAGEMENT (Admin)
// =====================================================================

async function loadAllUsers() {
  var r = await sb.from('profiles').select('*').order('created_at');
  return r.data || [];
}

async function loadSiteUsers(siteId) {
  var r = await sb.from('user_sites').select('*, profiles(*)').eq('site_id', siteId);
  return r.data || [];
}

async function assignUserToSite(userId, siteId, siteRole) {
  var r = await sb.rpc('admin_assign_user_to_site', { p_user_id: userId, p_site_id: siteId, p_site_role: siteRole });
  if (r.error) throw r.error;
}

async function removeUserFromSite(userId, siteId) {
  // Reste en direct ‚Äî la policy user_sites_delete exige super_admin
  var r = await sb.from('user_sites').delete().match({ user_id: userId, site_id: siteId });
  if (r.error) throw r.error;
}

async function updateUserRole(userId, newRole) {
  var r = await sb.rpc('admin_set_user_role', { p_target_user_id: userId, p_new_role: newRole });
  if (r.error) throw r.error;
}

// =====================================================================
// PHOTO HANDLING
// =====================================================================

function handlePhotoFor(inputId, context) {
  var input = document.getElementById(inputId);
  if (!input || !input.files || !input.files[0]) return;
  var file = input.files[0];
  var reader = new FileReader();
  reader.onload = function(e) {
    // Resize image
    var img = new Image();
    img.onload = function() {
      var canvas = document.createElement('canvas');
      var maxW = 1200;
      var scale = img.width > maxW ? maxW / img.width : 1;
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      if (context === 'dlc') {
        S.photoDlcData = dataUrl;
        // Try OCR for DLC date
        ocrDetectDate(dataUrl);
      } else {
        S.photoLotData = dataUrl;
        // Try OCR for lot number
        ocrDetectLot(dataUrl);
      }
      render();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function clearPhotoDlc() { S.photoDlcData = null; render(); }
function clearPhotoLot() { S.photoLotData = null; render(); }

// Simple OCR simulation (regex patterns on basic text extraction)
function ocrDetectDate(imgData) {
  // In production, this would use Tesseract.js or similar
  // For now, we provide a manual entry with photo reference
  console.log('OCR Date: photo captured for DLC reference');
}

function ocrDetectLot(imgData) {
  console.log('OCR Lot: photo captured for lot reference');
}

// =====================================================================
// SIGNATURE
// =====================================================================

var sigCanvas, sigCtx, sigDrawing = false;

function initSignature() {
  sigCanvas = document.getElementById('sigCanvas');
  if (!sigCanvas) return;
  sigCtx = sigCanvas.getContext('2d');
  // Set canvas actual size
  var rect = sigCanvas.getBoundingClientRect();
  sigCanvas.width = rect.width;
  sigCanvas.height = rect.height;
  sigCtx.strokeStyle = '#1a1a2e';
  sigCtx.lineWidth = 2;
  sigCtx.lineCap = 'round';
  sigCtx.lineJoin = 'round';
  sigDrawing = false;

  function getPos(e) {
    var r = sigCanvas.getBoundingClientRect();
    var t = e.touches ? e.touches[0] : e;
    return { x: t.clientX - r.left, y: t.clientY - r.top };
  }

  sigCanvas.onmousedown = sigCanvas.ontouchstart = function(e) {
    e.preventDefault(); sigDrawing = true;
    var p = getPos(e); sigCtx.beginPath(); sigCtx.moveTo(p.x, p.y);
  };
  sigCanvas.onmousemove = sigCanvas.ontouchmove = function(e) {
    if (!sigDrawing) return; e.preventDefault();
    var p = getPos(e); sigCtx.lineTo(p.x, p.y); sigCtx.stroke();
  };
  sigCanvas.onmouseup = sigCanvas.ontouchend = function() { sigDrawing = false; };
}

function clearSignature() {
  if (sigCanvas && sigCtx) {
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
  }
  S.sigData = null;
}

function saveSignature() {
  if (!sigCanvas) return;
  S.sigData = sigCanvas.toDataURL('image/png');
  closeModal();
  render();
}

// =====================================================================
// MODALS
// =====================================================================

function openModal(html) {
  $('modalContent').innerHTML = html;
  $('modalOverlay').classList.add('show');
  // Init signature if present
  setTimeout(function() { initSignature(); }, 100);
}

function closeModal() {
  $('modalOverlay').classList.remove('show');
}

// =====================================================================
// SIDEBAR
// =====================================================================

function toggleSidebar() {
  S.sidebarOpen = !S.sidebarOpen;
  var sb = document.querySelector('.sidebar');
  var bd = $('sidebarBackdrop');
  if (sb) sb.classList.toggle('open', S.sidebarOpen);
  if (bd) bd.classList.toggle('show', S.sidebarOpen);
}

function navigate(page) {
  S.page = page;
  S.filter = 'all';
  S.sidebarOpen = false;
  var sb = document.querySelector('.sidebar');
  var bd = $('sidebarBackdrop');
  if (sb) sb.classList.remove('open');
  if (bd) bd.classList.remove('show');
  render();
  window.scrollTo(0, 0);
}

// =====================================================================
// PDF GENERATION
// =====================================================================

function generateDailyPDF() {
  var site = currentSite();
  var siteName = site ? site.name : 'Site';
  var temps = S.data.temperatures;
  var todayStr = fmtD(today());

  var rows = '';
  temps.forEach(function(t) {
    var refName = '';
    if (t.record_type === 'equipment') {
      var eq = S.siteConfig.equipment.find(function(e){return e.id===t.equipment_id;});
      refName = eq ? eq.name : '√âquipement';
    } else {
      var pr = S.siteConfig.products.find(function(p){return p.id===t.product_id;});
      refName = pr ? pr.name : 'Produit';
    }
    rows += '<tr><td>' + fmtDT(t.recorded_at) + '</td><td>' + esc(refName) + '</td><td>' + t.value + '¬∞C</td><td>' + (t.is_conform ? '‚úÖ Conforme' : '‚ùå Non conforme') + '</td><td>' + esc(t.corrective_action || '‚Äî') + '</td><td>' + esc(t.recorded_by_name) + '</td></tr>';
  });

  var sigHtml = S.sigData ? '<div style="margin-top:20px"><strong>Signature :</strong><br><img src="' + S.sigData + '" style="max-width:200px;max-height:80px;border:1px solid #ccc;margin-top:8px"></div>' : '';

  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Rapport HACCP</title><style>body{font-family:Arial,sans-serif;padding:30px;font-size:13px}h1{color:#2563eb;font-size:20px;margin-bottom:4px}h2{font-size:14px;color:#666;margin-bottom:20px}table{width:100%;border-collapse:collapse;margin-top:16px}th{background:#2563eb;color:#fff;padding:8px 10px;text-align:left;font-size:12px}td{padding:8px 10px;border-bottom:1px solid #e5e7eb;font-size:12px}.header{border-bottom:2px solid #2563eb;padding-bottom:12px;margin-bottom:20px}.footer{margin-top:30px;padding-top:16px;border-top:1px solid #e5e7eb;font-size:11px;color:#999}</style></head><body>';
  html += '<div class="header"><h1>üõ°Ô∏è Rapport HACCP Journalier</h1><h2>' + esc(siteName) + ' ‚Äî ' + todayStr + '</h2></div>';
  html += '<table><thead><tr><th>Heure</th><th>Point de contr√¥le</th><th>Temp√©rature</th><th>Conformit√©</th><th>Action corrective</th><th>Op√©rateur</th></tr></thead><tbody>';
  if (rows) { html += rows; } else { html += '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999">Aucun relev√© enregistr√© ce jour</td></tr>'; }
  html += '</tbody></table>';
  html += sigHtml;
  html += '<div class="footer">G√©n√©r√© par HACCP Pro le ' + fmtDT(new Date()) + ' ‚Äî Document √† conserver 2 ans minimum (R√®glement CE 852/2004)</div>';
  html += '</body></html>';

  var w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.print();
}

// =====================================================================
// RENDER ENGINE
// =====================================================================

function render() {
  var app = $('app');
  if (!app) return;

  // Not authenticated
  if (!S.user) {
    app.innerHTML = renderAuth();
    return;
  }

  // Loading
  if (S.loading) {
    app.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;gap:12px"><div class="loading" style="width:32px;height:32px;border-width:3px"></div><span style="color:#666">Chargement...</span></div>';
    return;
  }

  // No sites
  if (S.sites.length === 0 && !isSuperAdmin()) {
    app.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:100vh"><div class="card" style="max-width:500px;margin:20px"><div class="card-body"><div class="empty"><div class="empty-icon">üè¢</div><div class="empty-title">Aucun site assign√©</div><div class="empty-text">Contactez votre administrateur pour √™tre ajout√© √† un site.</div></div></div></div></div>';
    return;
  }

  // Main app layout
  app.innerHTML = renderSidebar() + renderMainContent();

  // Re-init signature if on temp page
  if (S.page === 'temperatures') {
    setTimeout(function() { initSignature(); }, 50);
  }
}

// ‚îÄ‚îÄ AUTH RENDER ‚îÄ‚îÄ
function renderAuth() {
  return '<div class="auth-wrapper"><div class="auth-card">' +
    '<div class="auth-logo"><span style="font-size:48px">üõ°Ô∏è</span><h1>HACCP Pro</h1><p>Gestion de la s√©curit√© alimentaire</p></div>' +
    '<div id="authForm">' + renderLoginForm() + '</div>' +
    '<p style="text-align:center;font-size:12px;color:var(--gray);margin-top:16px">Contactez votre administrateur pour obtenir vos identifiants.</p>' +
    '</div></div>';
}

function renderLoginForm() {
  return '<form onsubmit="handleLogin(event)">' +
    '<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="loginEmail" required placeholder="votre@email.com"></div>' +
    '<div class="form-group"><label class="form-label">Mot de passe</label><input type="password" class="form-input" id="loginPass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>' +
    '<div id="loginError" class="form-error" style="display:none"></div>' +
    '<button type="submit" class="btn btn-primary btn-block btn-lg" id="loginBtn">Se connecter</button>' +
    '</form>';
}

function renderRegisterForm() {
  return '<form onsubmit="handleRegister(event)">' +
    '<div class="form-group"><label class="form-label">Nom complet</label><input type="text" class="form-input" id="regName" required placeholder="Jean Dupont"></div>' +
    '<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="regEmail" required placeholder="votre@email.com"></div>' +
    '<div class="form-group"><label class="form-label">Mot de passe</label><input type="password" class="form-input" id="regPass" required minlength="6" placeholder="6 caract√®res minimum"></div>' +
    '<div id="regError" class="form-error" style="display:none"></div>' +
    '<button type="submit" class="btn btn-primary btn-block btn-lg" id="regBtn">Cr√©er un compte</button>' +
    '</form>';
}

function renderChangePassword() {
  document.body.insertAdjacentHTML('beforeend',
    '<div class="pwd-overlay" id="pwdOverlay"><div class="pwd-card">' +
    '<h2>üîê Changement de mot de passe requis</h2>' +
    '<p>Votre mot de passe provisoire doit √™tre chang√© avant de continuer.</p>' +
    '<form onsubmit="handleChangePassword(event)">' +
    '<div class="form-group"><label class="form-label">Nouveau mot de passe</label><input type="password" class="form-input" id="newPass1" required minlength="6" placeholder="6 caract√®res minimum"></div>' +
    '<div class="form-group"><label class="form-label">Confirmer le mot de passe</label><input type="password" class="form-input" id="newPass2" required minlength="6" placeholder="Confirmez votre mot de passe"></div>' +
    '<div id="pwdError" class="form-error" style="display:none"></div>' +
    '<button type="submit" class="btn btn-primary btn-block btn-lg">Valider le nouveau mot de passe</button>' +
    '</form></div></div>'
  );
}

// ‚îÄ‚îÄ SIDEBAR RENDER ‚îÄ‚îÄ
function renderSidebar() {
  var site = currentSite();
  var pages = [];

  // Super Admin : Dashboard global + Administration + Param√®tres par site
  // G√©rant/Manager : Dashboard + menus m√©tier + param√®tres site
  // Employ√© : menus m√©tier uniquement

  var navHtml = '';

  if (isSuperAdmin()) {
    // Dashboard multi-sites
    pages.push({ id:'dashboard', icon:'üìä', label:'Tableau de bord' });
    pages.forEach(function(p) {
      navHtml += '<div class="nav-item' + (S.page===p.id?' active':'') + '" onclick="navigate(\'' + p.id + '\')"><span class="nav-icon">' + p.icon + '</span>' + p.label + '</div>';
    });
    // Administration
    navHtml += '<div class="nav-section">Administration</div>';
    navHtml += '<div class="nav-item' + (S.page==='sites'?' active':'') + '" onclick="navigate(\'sites\')"><span class="nav-icon">üè¢</span>Gestion sites</div>';
    navHtml += '<div class="nav-item' + (S.page==='admin'?' active':'') + '" onclick="navigate(\'admin\')"><span class="nav-icon">üë•</span>Utilisateurs</div>';
    // Param√®tres du site s√©lectionn√©
    if (S.currentSiteId) {
      navHtml += '<div class="nav-item' + (S.page==='settings'?' active':'') + '" onclick="navigate(\'settings\')"><span class="nav-icon">‚öôÔ∏è</span>Param√®tres site</div>';
    }
    // Mon profil
    navHtml += '<div class="nav-section">Mon compte</div>';
    navHtml += '<div class="nav-item' + (S.page==='profile'?' active':'') + '" onclick="navigate(\'profile\')"><span class="nav-icon">üë§</span>Mon profil</div>';
  } else {
    // Managers et employ√©s : menus m√©tier
    pages.push({ id:'dashboard', icon:'üìä', label:'Tableau de bord' });
    if (moduleEnabled('temperatures')) pages.push({ id:'temperatures', icon:'üå°Ô∏è', label:'Temp√©ratures' });
    if (moduleEnabled('dlc') || moduleEnabled('lots')) pages.push({ id:'dlc', icon:'üìã', label:'DLC & Tra√ßabilit√©' });
    if (moduleEnabled('orders')) pages.push({ id:'orders', icon:'üõí', label:'Commandes' });
    if (moduleEnabled('consignes')) pages.push({ id:'consignes', icon:'üí¨', label:'Consignes' });
    pages.push({ id:'reports', icon:'üìÑ', label:'Rapports PDF' });

    pages.forEach(function(p) {
      navHtml += '<div class="nav-item' + (S.page===p.id?' active':'') + '" onclick="navigate(\'' + p.id + '\')"><span class="nav-icon">' + p.icon + '</span>' + p.label + '</div>';
    });

    // Param√®tres site pour g√©rants/managers uniquement
    if (isManager()) {
      navHtml += '<div class="nav-section">Administration</div>';
      navHtml += '<div class="nav-item' + (S.page==='team'?' active':'') + '" onclick="navigate(\'team\')"><span class="nav-icon">üë•</span>Personnel</div>';
      navHtml += '<div class="nav-item' + (S.page==='settings'?' active':'') + '" onclick="navigate(\'settings\')"><span class="nav-icon">‚öôÔ∏è</span>Param√®tres site</div>';
    }

    // Mon profil pour tout le monde
    navHtml += '<div class="nav-section">Mon compte</div>';
    navHtml += '<div class="nav-item' + (S.page==='profile'?' active':'') + '" onclick="navigate(\'profile\')"><span class="nav-icon">üë§</span>Mon profil</div>';
  }

  // Site selector
  var siteOpts = '';
  S.sites.forEach(function(s) {
    siteOpts += '<option value="' + s.id + '"' + (s.id===S.currentSiteId?' selected':'') + '>' + esc(s.name) + '</option>';
  });
  var siteSelector = S.sites.length > 1 ?
    '<div class="site-selector"><select onchange="switchSite(this.value)">' + siteOpts + '</select></div>' : '';

  var roleName = S.profile ? ({super_admin:'Super Admin',manager:'G√©rant',employee:'Employ√©'}[S.profile.role] || 'Utilisateur') : '';

  return '<nav class="sidebar' + (S.sidebarOpen?' open':'') + '">' +
    '<div class="sidebar-header"><div class="sidebar-brand"><span>üõ°Ô∏è</span><h2>HACCP Pro</h2></div></div>' +
    siteSelector +
    '<div class="sidebar-nav">' + navHtml + '</div>' +
    '<div class="sidebar-user">' +
    '<div class="avatar">' + userInitials() + '</div>' +
    '<div class="user-info"><div class="user-name">' + esc(userName()) + '</div><div class="user-role">' + roleName + '</div></div>' +
    '<button class="btn btn-ghost btn-sm" onclick="doLogout()" title="D√©connexion">üö™</button>' +
    '</div></nav>';
}

// ‚îÄ‚îÄ MAIN CONTENT RENDER ‚îÄ‚îÄ
function renderMainContent() {
  var titles = {
    dashboard:'Tableau de bord', temperatures:'Temp√©ratures', dlc:'DLC & Tra√ßabilit√©',
    lots:'DLC & Tra√ßabilit√©', orders:'Commandes', consignes:'Consignes',
    reports:'Rapports PDF', settings:'Param√®tres du site', sites:'Gestion des sites', admin:'Gestion utilisateurs',
    profile:'Mon profil', team:'Personnel'
  };

  var content = '';
  switch(S.page) {
    case 'dashboard': content = renderDashboard(); break;
    case 'temperatures': content = renderTemperatures(); break;
    case 'dlc': content = renderDLC(); break;
    case 'lots': content = renderLots(); break;
    case 'orders': content = renderOrders(); break;
    case 'consignes': content = renderConsignes(); break;
    case 'reports': content = renderReports(); break;
    case 'settings': content = renderSettings(); break;
    case 'sites': content = renderSiteManagement(); break;
    case 'admin': content = renderUserManagement(); break;
    case 'profile': content = renderProfile(); break;
    case 'team': content = renderTeam(); break;
    default: content = renderDashboard();
  }

  return '<div class="main-content">' +
    '<header class="main-header"><button class="burger" onclick="toggleSidebar()">‚ò∞</button><h1>' + (titles[S.page] || 'HACCP Pro') + '</h1></header>' +
    '<div class="main-body">' + content + '</div></div>';
}

// =====================================================================
// PAGE: DASHBOARD
// =====================================================================

function renderDashboard() {
  // Multi-site dashboard for super_admin or managers with multiple sites
  if ((isSuperAdmin() || isManager()) && S.sites.length > 1) {
    return renderMultiSiteDashboard();
  }

  var site = currentSite();
  if (!site) {
    return '<div class="card"><div class="card-body"><div class="empty"><div class="empty-icon">üè¢</div><div class="empty-title">Aucun site s√©lectionn√©</div><div class="empty-text">' + (isSuperAdmin() ? 'Cr√©ez votre premier site dans "Gestion sites".' : 'Contactez votre administrateur.') + '</div></div></div></div>';
  }

  var tempCount = S.data.temperatures.length;
  var eqCount = S.siteConfig.equipment.length;
  var prCount = S.siteConfig.products.length;
  var totalExpected = eqCount + prCount;
  var dlcWarnings = S.data.dlcs.filter(function(d) { var days = daysUntil(d.dlc_date); return days <= 2 && days >= 0 && d.status !== 'consumed' && d.status !== 'discarded'; });
  var dlcExpired = S.data.dlcs.filter(function(d) { return daysUntil(d.dlc_date) < 0 && d.status !== 'consumed' && d.status !== 'discarded'; });
  var ordersToOrder = S.data.orders.filter(function(o) { return o.status === 'to_order'; });
  var ordersOrdered = S.data.orders.filter(function(o) { return o.status === 'ordered'; });
  var urgentConsignes = S.data.consignes.filter(function(c) { return c.priority === 'urgent'; });
  var normalConsignes = S.data.consignes.filter(function(c) { return c.priority !== 'urgent'; }).slice(0, 5);

  var h = '';

  // Header avec nom du site
  h += '<div style="margin-bottom:16px"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">' + ({hotel:'üè®',restaurant:'üçΩÔ∏è',cuisine_centrale:'üè≠',autre:'üè¢'}[site.type]||'üè¢') + '</span><div><h2 style="margin:0;font-size:18px;font-weight:700;color:#1a1a2e">' + esc(site.name) + '</h2><span style="font-size:12px;color:var(--gray)">' + (site.address||'') + (site.city ? ', ' + site.city : '') + '</span></div></div></div>';

  // Stats cards
  h += '<div class="stats-grid">';
  h += '<div class="stat-card' + (tempCount >= totalExpected ? ' success' : '') + '"><div class="stat-value">' + tempCount + '/' + totalExpected + '</div><div class="stat-label">üå°Ô∏è Relev√©s aujourd\'hui</div></div>';
  h += '<div class="stat-card' + (dlcWarnings.length > 0 ? ' warning' : ' success') + '"><div class="stat-value">' + dlcWarnings.length + '</div><div class="stat-label">üìÖ DLC √† surveiller</div></div>';
  h += '<div class="stat-card' + (dlcExpired.length > 0 ? ' danger' : ' success') + '"><div class="stat-value">' + dlcExpired.length + '</div><div class="stat-label">‚ùå DLC expir√©es</div></div>';
  h += '<div class="stat-card' + (ordersToOrder.length > 0 ? ' warning' : ' success') + '"><div class="stat-value">' + ordersToOrder.length + '</div><div class="stat-label">üõí √Ä commander</div></div>';
  h += '</div>';

  // Barre de progression relev√©s
  if (totalExpected > 0) {
    var pct = Math.min(100, Math.round(tempCount / totalExpected * 100));
    h += '<div class="card"><div class="card-body"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><strong>Progression relev√©s du jour</strong><span style="font-weight:700;color:' + (pct >= 100 ? 'var(--success)' : 'var(--primary)') + '">' + pct + '%</span></div><div class="progress"><div class="progress-bar" style="width:' + pct + '%;background:' + (pct >= 100 ? 'var(--success)' : 'var(--primary)') + '"></div></div></div></div>';
  }

  // ‚îÄ‚îÄ CONSIGNES URGENTES ‚îÄ‚îÄ
  if (urgentConsignes.length > 0) {
    h += '<div class="card" style="border-left:4px solid var(--danger)"><div class="card-header" style="color:var(--danger)">üö® Consignes urgentes <span class="badge badge-red" style="margin-left:auto">' + urgentConsignes.length + '</span></div><div class="card-body">';
    urgentConsignes.forEach(function(c) {
      h += '<div class="list-item" style="border-bottom:1px solid var(--gray-border);padding:10px 0">';
      h += '<div class="list-content"><div class="list-title" style="color:var(--danger);font-weight:600">' + esc(c.message) + '</div>';
      h += '<div class="list-sub">Par ' + esc(c.created_by_name) + ' ¬∑ ' + fmtDT(c.created_at) + '</div></div>';
      h += '<div class="list-actions"><button class="btn btn-success btn-sm" onclick="markConsigneRead(\'' + c.id + '\')">‚úì Trait√©</button></div>';
      h += '</div>';
    });
    h += '</div></div>';
  }

  // ‚îÄ‚îÄ CONSIGNES R√âCENTES ‚îÄ‚îÄ
  if (normalConsignes.length > 0) {
    h += '<div class="card"><div class="card-header">üí¨ Derni√®res consignes</div><div class="card-body">';
    normalConsignes.forEach(function(c) {
      var prioStyle = c.priority === 'high' ? 'color:var(--warning)' : '';
      h += '<div class="list-item" style="border-bottom:1px solid var(--gray-border);padding:8px 0">';
      h += '<div class="list-content"><div class="list-title" style="' + prioStyle + '">' + esc(c.message) + '</div>';
      h += '<div class="list-sub">' + esc(c.created_by_name) + ' ¬∑ ' + fmtDT(c.created_at) + '</div></div></div>';
    });
    h += '<div style="text-align:center;padding-top:8px"><button class="btn btn-ghost btn-sm" onclick="navigate(\'consignes\')">Voir toutes les consignes ‚Üí</button></div>';
    h += '</div></div>';
  }

  // ‚îÄ‚îÄ DLC ALERTES ‚îÄ‚îÄ
  if (dlcExpired.length > 0 || dlcWarnings.length > 0) {
    h += '<div class="card" style="border-left:4px solid ' + (dlcExpired.length > 0 ? 'var(--danger)' : 'var(--warning)') + '"><div class="card-header">üìÖ Alertes DLC <span class="badge ' + (dlcExpired.length > 0 ? 'badge-red' : 'badge-yellow') + '" style="margin-left:auto">' + (dlcExpired.length + dlcWarnings.length) + '</span></div><div class="card-body">';
    
    dlcExpired.forEach(function(d) {
      h += '<div class="list-item" style="border-bottom:1px solid var(--gray-border);padding:8px 0">';
      h += '<div class="list-content"><div class="list-title" style="color:var(--danger)">' + esc(d.product_name) + ' <span class="badge badge-red">Expir√© (J' + daysUntil(d.dlc_date) + ')</span></div>';
      h += '<div class="list-sub">DLC : ' + fmtD(d.dlc_date) + (d.lot_number ? ' ¬∑ Lot : ' + esc(d.lot_number) : '') + '</div></div>';
      h += '<div class="list-actions">';
      h += '<button class="btn btn-danger btn-sm" onclick="updateDlcStatus(\'' + d.id + '\',\'discarded\')">Jeter</button>';
      h += '<button class="btn btn-success btn-sm" onclick="updateDlcStatus(\'' + d.id + '\',\'consumed\')">Utilis√©</button>';
      h += '</div></div>';
    });
    
    dlcWarnings.forEach(function(d) {
      var days = daysUntil(d.dlc_date);
      h += '<div class="list-item" style="border-bottom:1px solid var(--gray-border);padding:8px 0">';
      h += '<div class="list-content"><div class="list-title" style="color:var(--warning)">' + esc(d.product_name) + ' <span class="badge badge-yellow">J-' + days + '</span></div>';
      h += '<div class="list-sub">DLC : ' + fmtD(d.dlc_date) + (d.lot_number ? ' ¬∑ Lot : ' + esc(d.lot_number) : '') + '</div></div>';
      h += '<div class="list-actions"><button class="btn btn-success btn-sm" onclick="updateDlcStatus(\'' + d.id + '\',\'consumed\')">Utilis√©</button></div>';
      h += '</div>';
    });
    
    h += '</div></div>';
  }

  // ‚îÄ‚îÄ COMMANDES EN ATTENTE (liste des courses) ‚îÄ‚îÄ
  if (ordersToOrder.length > 0) {
    // Grouper par fournisseur
    var bySupplier = {};
    ordersToOrder.forEach(function(o) {
      var key = o.supplier_name || '‚Äî Sans fournisseur ‚Äî';
      if (!bySupplier[key]) bySupplier[key] = [];
      bySupplier[key].push(o);
    });

    h += '<div class="card" style="border-left:4px solid var(--warning)"><div class="card-header">üõí Liste des courses <span class="badge badge-yellow" style="margin-left:auto">' + ordersToOrder.length + ' article' + (ordersToOrder.length > 1 ? 's' : '') + '</span></div><div class="card-body">';
    
    Object.keys(bySupplier).forEach(function(supplier) {
      h += '<div style="margin-bottom:16px">';
      h += '<h4 style="font-size:14px;font-weight:700;color:#1a1a2e;margin:0 0 8px;padding-bottom:6px;border-bottom:2px solid var(--primary-light)">üè≠ ' + esc(supplier) + '</h4>';
      bySupplier[supplier].forEach(function(o) {
        h += '<div class="list-item" style="padding:6px 0">';
        h += '<div class="list-content"><div class="list-title">' + esc(o.product_name) + '</div>';
        h += '<div class="list-sub">' + (o.quantity || 1) + ' ' + (o.unit || 'unit√©') + (o.notes ? ' ¬∑ ' + esc(o.notes) : '') + '</div></div>';
        h += '<div class="list-actions"><button class="btn btn-success btn-sm" onclick="dashMarkOrdered(\'' + o.id + '\')">‚úì Command√©</button></div>';
        h += '</div>';
      });
      h += '</div>';
    });
    
    h += '</div></div>';
  }

  // ‚îÄ‚îÄ COMMANDES EN COURS DE LIVRAISON ‚îÄ‚îÄ
  if (ordersOrdered.length > 0) {
    h += '<div class="card"><div class="card-header">üì¶ En attente de livraison <span class="badge badge-blue" style="margin-left:auto">' + ordersOrdered.length + '</span></div><div class="card-body">';
    ordersOrdered.forEach(function(o) {
      h += '<div class="list-item" style="padding:6px 0">';
      h += '<div class="list-content"><div class="list-title">' + esc(o.product_name) + '</div>';
      h += '<div class="list-sub">' + (o.supplier_name ? 'üè≠ ' + esc(o.supplier_name) + ' ¬∑ ' : '') + (o.quantity || 1) + ' ' + (o.unit || 'unit√©') + ' ¬∑ Command√© le ' + fmtD(o.ordered_at) + '</div></div>';
      h += '<div class="list-actions"><button class="btn btn-primary btn-sm" onclick="dashMarkReceived(\'' + o.id + '\')">‚úì Re√ßu</button></div>';
      h += '</div>';
    });
    h += '</div></div>';
  }

  // Quick actions
  h += '<div class="card"><div class="card-header">‚ö° Actions rapides</div><div class="card-body" style="display:flex;flex-wrap:wrap;gap:10px">';
  if (moduleEnabled('temperatures')) h += '<button class="btn btn-primary" onclick="navigate(\'temperatures\')">üå°Ô∏è Saisir temp√©ratures</button>';
  if (moduleEnabled('dlc') || moduleEnabled('lots')) h += '<button class="btn btn-warning" onclick="navigate(\'dlc\')">üìã DLC & Tra√ßabilit√©</button>';
  if (moduleEnabled('orders')) h += '<button class="btn btn-success" onclick="navigate(\'orders\')">üõí Commandes</button>';
  if (moduleEnabled('consignes')) h += '<button class="btn btn-ghost" onclick="navigate(\'consignes\')">üí¨ Consignes</button>';
  h += '<button class="btn btn-ghost" onclick="navigate(\'reports\')">üìÑ Rapport PDF</button>';
  h += '</div></div>';

  return h;
}

// =====================================================================
// PAGE: MULTI-SITE DASHBOARD (Super Admin / Multi-site Managers)
// =====================================================================

var _multiSiteCache = null;
var _multiSiteCacheTime = 0;

async function loadMultiSiteStats() {
  var now = Date.now();
  // Cache 30 secondes pour √©viter les requ√™tes multiples
  if (_multiSiteCache && (now - _multiSiteCacheTime) < 30000) return _multiSiteCache;

  var todayStr = today();
  var stats = [];

  for (var i = 0; i < S.sites.length; i++) {
    var site = S.sites[i];
    var sid = site.id;

    try {
      var t = await sb.from('temperatures').select('id', {count:'exact', head:true}).eq('site_id', sid).gte('recorded_at', todayStr + 'T00:00:00');
      var eq = await sb.from('site_equipment').select('id', {count:'exact', head:true}).eq('site_id', sid).eq('active', true);
      var pr = await sb.from('site_products').select('id', {count:'exact', head:true}).eq('site_id', sid).eq('active', true);
      var d = await sb.from('dlcs').select('id, dlc_date, status').eq('site_id', sid).not('status', 'in', '("consumed","discarded")');
      var o = await sb.from('orders').select('id', {count:'exact', head:true}).eq('site_id', sid).eq('status', 'to_order');
      var c = await sb.from('consignes').select('id', {count:'exact', head:true}).eq('site_id', sid).eq('priority', 'urgent');

      var dlcData = d.data || [];
      var dlcWarnings = dlcData.filter(function(x) { var days = daysUntil(x.dlc_date); return days <= 2 && days >= 0; }).length;
      var dlcExpired = dlcData.filter(function(x) { return daysUntil(x.dlc_date) < 0; }).length;

      stats.push({
        site: site,
        tempCount: t.count || 0,
        totalExpected: (eq.count || 0) + (pr.count || 0),
        dlcWarnings: dlcWarnings,
        dlcExpired: dlcExpired,
        ordersOpen: o.count || 0,
        urgentConsignes: c.count || 0
      });
    } catch(e) {
      console.error('Stats error for site', site.name, e);
      stats.push({ site: site, tempCount: 0, totalExpected: 0, dlcWarnings: 0, dlcExpired: 0, ordersOpen: 0, urgentConsignes: 0 });
    }
  }

  _multiSiteCache = stats;
  _multiSiteCacheTime = now;
  return stats;
}

function renderMultiSiteDashboard() {
  var h = '';

  // Titre
  h += '<div style="margin-bottom:20px"><h2 style="font-size:22px;font-weight:800;color:#1a1a2e;margin:0">üõ°Ô∏è Vue globale ‚Äî ' + S.sites.length + ' site' + (S.sites.length > 1 ? 's' : '') + '</h2><p style="color:var(--gray);font-size:13px;margin:4px 0 0">Derni√®re actualisation : ' + new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'}) + ' ‚Äî <a href="#" onclick="event.preventDefault();_multiSiteCache=null;loadAndRenderMultiDashboard();" style="color:var(--primary)">‚Üª Actualiser</a></p></div>';

  // Container pour les stats charg√©es en async
  h += '<div id="multiDashContainer"><div style="text-align:center;padding:60px"><div class="loading"></div><div style="margin-top:12px;color:var(--gray);font-size:14px">Chargement des donn√©es de tous les sites...</div></div></div>';

  // Lancer le chargement async
  setTimeout(function() { loadAndRenderMultiDashboard(); }, 50);

  return h;
}

async function loadAndRenderMultiDashboard() {
  var container = $('multiDashContainer');
  if (!container) return;

  var stats = await loadMultiSiteStats();
  var h = '';

  // Calcul des totaux
  var totalTemp = 0, totalExpected = 0, totalDlcWarn = 0, totalDlcExp = 0, totalOrders = 0, totalUrgent = 0;
  var sitesOk = 0;

  stats.forEach(function(s) {
    totalTemp += s.tempCount;
    totalExpected += s.totalExpected;
    totalDlcWarn += s.dlcWarnings;
    totalDlcExp += s.dlcExpired;
    totalOrders += s.ordersOpen;
    totalUrgent += s.urgentConsignes;
    if (s.totalExpected > 0 && s.tempCount >= s.totalExpected && s.dlcExpired === 0) sitesOk++;
  });

  var globalPct = totalExpected > 0 ? Math.round(totalTemp / totalExpected * 100) : 0;

  // Banni√®re globale
  h += '<div class="global-stats-banner">';
  h += '<div class="global-stat"><div class="gs-value">' + S.sites.length + '</div><div class="gs-label">Sites actifs</div></div>';
  h += '<div class="global-stat' + (globalPct >= 100 ? ' gs-success' : '') + '"><div class="gs-value">' + globalPct + '%</div><div class="gs-label">Relev√©s compl√©t√©s</div></div>';
  h += '<div class="global-stat' + (totalDlcExp > 0 ? ' gs-danger' : ' gs-success') + '"><div class="gs-value">' + totalDlcExp + '</div><div class="gs-label">DLC expir√©es</div></div>';
  h += '<div class="global-stat' + (totalDlcWarn > 0 ? ' gs-warning' : ' gs-success') + '"><div class="gs-value">' + totalDlcWarn + '</div><div class="gs-label">DLC √† surveiller</div></div>';
  h += '<div class="global-stat"><div class="gs-value">' + totalOrders + '</div><div class="gs-label">Commandes en attente</div></div>';
  h += '<div class="global-stat' + (totalUrgent > 0 ? ' gs-danger' : ' gs-success') + '"><div class="gs-value">' + totalUrgent + '</div><div class="gs-label">Alertes urgentes</div></div>';
  h += '</div>';

  // Barre de progression globale
  h += '<div class="card" style="margin-bottom:20px"><div class="card-body"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><strong>Progression globale des relev√©s</strong><span style="font-weight:700;color:' + (globalPct >= 100 ? 'var(--success)' : 'var(--primary)') + '">' + totalTemp + '/' + totalExpected + ' (' + globalPct + '%)</span></div><div class="progress"><div class="progress-bar" style="width:' + Math.min(100, globalPct) + '%;background:' + (globalPct >= 100 ? 'var(--success)' : globalPct >= 50 ? 'var(--primary)' : 'var(--warning)') + '"></div></div></div></div>';

  // Carte par site
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="font-size:16px;font-weight:700;color:#1a1a2e;margin:0">D√©tail par site</h3><span style="font-size:12px;color:var(--gray)">' + sitesOk + '/' + S.sites.length + ' sites conformes</span></div>';

  stats.forEach(function(s) {
    var site = s.site;
    var pct = s.totalExpected > 0 ? Math.round(s.tempCount / s.totalExpected * 100) : 0;
    var typeEmoji = {hotel:'üè®',restaurant:'üçΩÔ∏è',cuisine_centrale:'üè≠',autre:'üè¢'}[site.type] || 'üè¢';
    var isOk = pct >= 100 && s.dlcExpired === 0 && s.urgentConsignes === 0;
    var borderColor = isOk ? 'var(--success)' : s.dlcExpired > 0 || s.urgentConsignes > 0 ? 'var(--danger)' : 'var(--primary)';

    h += '<div class="site-overview-card" style="border-left-color:' + borderColor + '" onclick="switchSite(\'' + site.id + '\');navigate(\'dashboard\');">';
    h += '<div class="site-card-header"><div class="site-card-title">' + typeEmoji + ' ' + esc(site.name) + '</div><div class="site-card-badges">';
    if (isOk) h += '<span class="badge badge-green">‚úì Conforme</span>';
    if (s.dlcExpired > 0) h += '<span class="badge badge-red">‚ö† ' + s.dlcExpired + ' DLC expir√©e' + (s.dlcExpired > 1 ? 's' : '') + '</span>';
    if (s.urgentConsignes > 0) h += '<span class="badge badge-red">üö® ' + s.urgentConsignes + ' urgente' + (s.urgentConsignes > 1 ? 's' : '') + '</span>';
    if (pct < 100 && pct > 0) h += '<span class="badge badge-yellow">' + pct + '% relev√©s</span>';
    if (pct === 0 && s.totalExpected > 0) h += '<span class="badge badge-yellow">Aucun relev√©</span>';
    h += '</div></div>';

    h += '<div class="mini-stats">';
    h += '<div class="mini-stat' + (pct >= 100 ? ' ok' : pct > 0 ? ' warn' : '') + '"><div class="mini-stat-value">' + s.tempCount + '/' + s.totalExpected + '</div><div class="mini-stat-label">üå°Ô∏è Relev√©s</div></div>';
    h += '<div class="mini-stat' + (s.dlcExpired > 0 ? ' bad' : s.dlcWarnings > 0 ? ' warn' : ' ok') + '"><div class="mini-stat-value">' + (s.dlcExpired + s.dlcWarnings) + '</div><div class="mini-stat-label">üìÖ DLC alertes</div></div>';
    h += '<div class="mini-stat"><div class="mini-stat-value">' + s.ordersOpen + '</div><div class="mini-stat-label">üõí Commandes</div></div>';
    h += '<div class="mini-stat' + (s.urgentConsignes > 0 ? ' bad' : ' ok') + '"><div class="mini-stat-value">' + s.urgentConsignes + '</div><div class="mini-stat-label">üí¨ Urgentes</div></div>';
    h += '</div>';

    // Mini progress bar
    h += '<div style="margin-top:10px"><div class="progress" style="height:6px"><div class="progress-bar" style="width:' + Math.min(100, pct) + '%;background:' + (pct >= 100 ? 'var(--success)' : 'var(--primary)') + '"></div></div></div>';

    h += '</div>';
  });

  container.innerHTML = h;
}

// =====================================================================
// PAGE: TEMPERATURES
// =====================================================================

function renderTemperatures() {
  var h = '';
  var site = currentSite();
  var servicesPerDay = (site && site.services_per_day) || 1;
  var eqCount = S.siteConfig.equipment.length;
  var prCount = S.siteConfig.products.length;
  var totalPerService = eqCount + prCount;
  var totalExpected = totalPerService * servicesPerDay;
  var tempCount = S.data.temperatures.length;
  var currentService = totalPerService > 0 ? Math.floor(tempCount / totalPerService) + 1 : 1;
  if (currentService > servicesPerDay) currentService = servicesPerDay;
  var serviceProgress = totalPerService > 0 ? tempCount % totalPerService : 0;
  if (tempCount > 0 && tempCount % totalPerService === 0) serviceProgress = totalPerService; // Service complet
  var pct = totalExpected > 0 ? Math.min(100, Math.round(tempCount / totalExpected * 100)) : 0;
  var servicePct = totalPerService > 0 ? Math.min(100, Math.round(serviceProgress / totalPerService * 100)) : 0;

  // Non-conform temperatures today
  var nonConform = S.data.temperatures.filter(function(t) { return !t.is_conform; });

  // Status banner
  h += '<div class="card" style="border-left:4px solid ' + (pct >= 100 ? 'var(--success)' : 'var(--primary)') + '"><div class="card-body">';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">';
  h += '<div><h3 style="margin:0;font-size:16px;font-weight:700">Service ' + currentService + '/' + servicesPerDay + '</h3>';
  h += '<span style="font-size:13px;color:var(--gray)">' + serviceProgress + '/' + totalPerService + ' relev√©s ce service</span></div>';
  h += '<div style="text-align:right"><div style="font-size:28px;font-weight:800;color:' + (pct >= 100 ? 'var(--success)' : 'var(--primary)') + '">' + tempCount + '/' + totalExpected + '</div>';
  h += '<span style="font-size:12px;color:var(--gray)">Total journ√©e (' + servicesPerDay + ' service' + (servicesPerDay > 1 ? 's' : '') + ')</span></div>';
  h += '</div>';

  // Progress bar du service actuel
  h += '<div style="margin-top:12px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;font-weight:600">Progression service ' + currentService + '</span><span style="font-size:12px;font-weight:700;color:' + (servicePct >= 100 ? 'var(--success)' : 'var(--primary)') + '">' + servicePct + '%</span></div>';
  h += '<div class="progress"><div class="progress-bar" style="width:' + servicePct + '%;background:' + (servicePct >= 100 ? 'var(--success)' : 'var(--primary)') + '"></div></div></div>';

  // Non-conform warning
  if (nonConform.length > 0) {
    h += '<div style="margin-top:10px;padding:8px 12px;background:var(--danger-bg);border-radius:6px;font-size:13px;color:var(--danger)">‚ö†Ô∏è <strong>' + nonConform.length + ' relev√©' + (nonConform.length > 1 ? 's' : '') + ' non conforme' + (nonConform.length > 1 ? 's' : '') + '</strong> ‚Äî Action corrective requise</div>';
  }

  // Validation button
  if (serviceProgress >= totalPerService && totalPerService > 0) {
    h += '<div style="margin-top:12px;text-align:center"><button class="btn btn-success btn-lg" onclick="validateService(' + currentService + ',' + nonConform.length + ')">‚úÖ Valider le service ' + currentService + '</button></div>';
  }

  h += '</div></div>';

  // Form - Equipment
  h += '<div class="card"><div class="card-header">‚ùÑÔ∏è Relev√© √âquipement <span class="badge badge-blue" style="margin-left:auto">' + eqCount + ' √©quipements</span></div><div class="card-body"><form onsubmit="handleTempEquip(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">√âquipement <span class="req">*</span></label><select class="form-select" id="tempEq" required><option value="">S√©lectionner...</option>';
  S.siteConfig.equipment.forEach(function(e) {
    // Check if already recorded this service
    var alreadyDone = S.data.temperatures.some(function(t) { return t.equipment_id === e.id && t.record_type === 'equipment'; });
    h += '<option value="' + e.id + '"' + (alreadyDone ? ' style="color:green"' : '') + '>' + (alreadyDone ? '‚úÖ ' : '') + e.emoji + ' ' + esc(e.name) + ' (' + e.temp_min + '¬∞/' + e.temp_max + '¬∞C)</option>';
  });
  h += '</select></div><div class="form-group"><label class="form-label">Temp√©rature ¬∞C <span class="req">*</span></label><input type="number" step="0.1" class="form-input" id="tempEqVal" required placeholder="Ex: 3.5"></div></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Enregistrer</button></form></div></div>';

  // Form - Product
  h += '<div class="card"><div class="card-header">üçΩÔ∏è Relev√© Produit <span class="badge badge-blue" style="margin-left:auto">' + prCount + ' produits</span></div><div class="card-body"><form onsubmit="handleTempProd(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Produit <span class="req">*</span></label><select class="form-select" id="tempPr" required><option value="">S√©lectionner...</option>';
  S.siteConfig.products.forEach(function(p) {
    var alreadyDone = S.data.temperatures.some(function(t) { return t.product_id === p.id && t.record_type === 'product'; });
    h += '<option value="' + p.id + '"' + (alreadyDone ? ' style="color:green"' : '') + '>' + (alreadyDone ? '‚úÖ ' : '') + p.emoji + ' ' + esc(p.name) + ' (' + p.temp_min + '¬∞/' + p.temp_max + '¬∞C)</option>';
  });
  h += '</select></div><div class="form-group"><label class="form-label">Temp√©rature ¬∞C <span class="req">*</span></label><input type="number" step="0.1" class="form-input" id="tempPrVal" required placeholder="Ex: 2.0"></div></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Enregistrer</button></form></div></div>';

  // Signature
  h += '<div class="card"><div class="card-header">‚úçÔ∏è Signature</div><div class="card-body">';
  if (S.sigData) {
    h += '<div style="display:flex;align-items:center;gap:12px"><img src="' + S.sigData + '" style="max-width:200px;max-height:60px;border:1px solid var(--gray-border);border-radius:8px"><button class="btn btn-ghost btn-sm" onclick="S.sigData=null;render()">‚úï Effacer</button></div>';
  } else {
    h += '<button class="btn btn-ghost" onclick="openSignatureModal()">‚úçÔ∏è Signer les relev√©s</button>';
  }
  h += '</div></div>';

  // Today's records
  h += '<div class="card"><div class="card-header">üìã Relev√©s du jour <span class="badge badge-blue" style="margin-left:auto">' + tempCount + '/' + totalExpected + '</span></div>';
  if (S.data.temperatures.length === 0) {
    h += '<div class="card-body"><div class="empty"><div class="empty-icon">üå°Ô∏è</div><div class="empty-title">Aucun relev√© aujourd\'hui</div></div></div>';
  } else {
    S.data.temperatures.forEach(function(t) {
      var refName = '', emoji = '';
      if (t.record_type === 'equipment') {
        var eq = S.siteConfig.equipment.find(function(e){return e.id===t.equipment_id;});
        refName = eq ? eq.name : '√âquipement';
        emoji = eq ? eq.emoji : '‚ùÑÔ∏è';
      } else {
        var pr = S.siteConfig.products.find(function(p){return p.id===t.product_id;});
        refName = pr ? pr.name : 'Produit';
        emoji = pr ? pr.emoji : 'üì¶';
      }
      var bgColor = t.is_conform ? 'var(--success-bg)' : 'var(--danger-bg)';
      var borderColor = t.is_conform ? 'var(--success)' : 'var(--danger)';
      h += '<div class="list-item" style="border-left:3px solid ' + borderColor + '"><div class="list-icon" style="background:' + bgColor + '">' + emoji + '</div><div class="list-content"><div class="list-title">' + esc(refName) + '</div><div class="list-sub"><strong>' + t.value + '¬∞C</strong> ‚Äî ' + (t.is_conform ? '‚úÖ Conforme' : '‚ùå Non conforme') + ' ‚Äî ' + fmtDT(t.recorded_at) + '</div>';
      if (t.corrective_action) h += '<div class="list-sub" style="color:var(--warning)">‚ö†Ô∏è ' + esc(t.corrective_action) + '</div>';
      h += '</div></div>';
    });
  }
  h += '</div>';

  return h;
}

window.validateService = function(serviceNum, nonConformCount) {
  if (nonConformCount > 0) {
    if (!confirm('‚ö†Ô∏è ATTENTION : ' + nonConformCount + ' relev√©(s) non conforme(s) d√©tect√©(s) !\n\n√ätes-vous s√ªr de vouloir valider le service ' + serviceNum + ' malgr√© ces anomalies ?\n\nUne action corrective devrait √™tre document√©e.')) {
      return;
    }
  }
  if (!S.sigData) {
    alert('‚úçÔ∏è Veuillez signer avant de valider le service.');
    openSignatureModal();
    return;
  }
  alert('‚úÖ Service ' + serviceNum + ' valid√© avec succ√®s !\n\nRelev√©s : ' + S.data.temperatures.length + '\nSignature : ‚úì\n' + (nonConformCount > 0 ? '‚ö†Ô∏è ' + nonConformCount + ' non-conformit√©(s) signal√©e(s)' : '‚úÖ Tous les relev√©s conformes'));
};

// =====================================================================
// PAGE: DLC & TRA√áABILIT√â (fusionn√©)
// =====================================================================

function renderDLC() {
  var h = '';
  
  // Onglets DLC / Tra√ßabilit√©
  if (!S.dlcTab) S.dlcTab = 'dlc';
  h += '<div class="tabs" style="margin-bottom:16px">';
  h += '<button class="tab' + (S.dlcTab==='dlc'?' active':'') + '" onclick="S.dlcTab=\'dlc\';render()">üìÖ Contr√¥le DLC</button>';
  h += '<button class="tab' + (S.dlcTab==='lots'?' active':'') + '" onclick="S.dlcTab=\'lots\';render()">üì¶ Tra√ßabilit√© lots</button>';
  h += '</div>';

  if (S.dlcTab === 'dlc') {
    h += renderDlcTab();
  } else {
    h += renderLotsTab();
  }

  return h;
}

function renderDlcTab() {
  var h = '';

  // Form
  h += '<div class="card"><div class="card-header">‚ûï Nouveau contr√¥le DLC</div><div class="card-body"><form onsubmit="handleDlc(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Produit <span class="req">*</span></label><input type="text" class="form-input" id="dlcProd" required placeholder="Nom du produit"></div>';
  h += '<div class="form-group"><label class="form-label">Date DLC <span class="req">*</span></label><input type="date" class="form-input" id="dlcDate" required></div></div>';
  h += '<div class="form-group"><label class="form-label">N¬∞ de lot</label><input type="text" class="form-input" id="dlcLot" placeholder="Optionnel" style="text-transform:uppercase"></div>';

  // Photo zone DLC
  h += '<div class="form-group"><label class="form-label">üì∏ Photo de l\'√©tiquette</label>';
  if (S.photoDlcData) {
    h += '<div style="text-align:center;padding:12px;border:2px solid var(--success);border-radius:var(--radius);background:var(--success-bg)"><img src="' + S.photoDlcData + '" class="photo-preview"><br><button type="button" class="btn btn-ghost btn-sm" onclick="clearPhotoDlc()">‚úï Supprimer la photo</button></div>';
  } else {
    h += '<label class="photo-box" for="photoDlcInput"><div class="photo-icon">üì∑</div><div class="photo-text">Prendre une photo de l\'√©tiquette</div><div class="photo-hint">La date DLC sera d√©tect√©e si possible</div></label><input type="file" id="photoDlcInput" accept="image/*" capture="environment" onchange="handlePhotoFor(\'photoDlcInput\',\'dlc\')" style="display:none">';
  }
  h += '</div>';

  h += '<div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="dlcNotes" rows="2" placeholder="Observations..."></textarea></div>';
  h += '<button type="submit" class="btn btn-success btn-block">‚úì Enregistrer le contr√¥le DLC</button></form></div></div>';

  // Filters
  h += '<div class="filters">';
  ['all','warning','expired'].forEach(function(f) {
    var labels = {all:'Tous',warning:'‚ö†Ô∏è √Ä surveiller',expired:'‚ùå Expir√©s'};
    h += '<button class="filter-btn' + (S.filter===f?' active':'') + '" onclick="S.filter=\'' + f + '\';render()">' + labels[f] + '</button>';
  });
  h += '</div>';

  // List
  var dlcs = S.data.dlcs.filter(function(d) {
    if (d.status === 'consumed' || d.status === 'discarded') return false;
    if (S.filter === 'warning') return daysUntil(d.dlc_date) <= 2 && daysUntil(d.dlc_date) >= 0;
    if (S.filter === 'expired') return daysUntil(d.dlc_date) < 0;
    return true;
  });

  h += '<div class="card"><div class="card-header">üìÖ Suivi DLC <span class="badge badge-gray" style="margin-left:auto">' + dlcs.length + '</span></div>';
  if (dlcs.length === 0) {
    h += '<div class="card-body"><div class="empty"><div class="empty-icon">üìÖ</div><div class="empty-title">Aucun contr√¥le DLC</div></div></div>';
  } else {
    dlcs.forEach(function(d) {
      var days = daysUntil(d.dlc_date);
      var status = days < 0 ? 'expired' : days <= 2 ? 'warning' : 'valid';
      var statusLabel = days < 0 ? 'Expir√© (J' + days + ')' : days === 0 ? 'Expire aujourd\'hui' : days <= 2 ? 'J-' + days : 'OK (J-' + days + ')';
      var badgeClass = {valid:'badge-green',warning:'badge-yellow',expired:'badge-red'}[status];
      var borderColor = {valid:'var(--success)',warning:'var(--warning)',expired:'var(--danger)'}[status];
      h += '<div class="list-item" style="border-left:3px solid ' + borderColor + '"><div class="list-content"><div class="list-title">' + esc(d.product_name) + '</div><div class="list-sub">DLC : <strong>' + fmtD(d.dlc_date) + '</strong> <span class="badge ' + badgeClass + '">' + statusLabel + '</span></div>';
      if (d.lot_number) h += '<div class="list-sub">Lot : ' + esc(d.lot_number) + '</div>';
      h += '</div><div class="list-actions">';
      if (status === 'expired') h += '<button class="btn btn-danger btn-sm" onclick="updateDlcStatus(\'' + d.id + '\',\'discarded\')">Jet√©</button>';
      h += '<button class="btn btn-success btn-sm" onclick="updateDlcStatus(\'' + d.id + '\',\'consumed\')">Utilis√©</button>';
      h += '<button class="btn btn-ghost btn-sm" onclick="deleteDlc(\'' + d.id + '\')">üóëÔ∏è</button>';
      h += '</div></div>';
    });
  }
  h += '</div>';

  return h;
}

function renderLotsTab() {
  var h = '';

  h += '<div class="card"><div class="card-header">‚ûï Enregistrer un lot</div><div class="card-body"><form onsubmit="handleLot(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Produit <span class="req">*</span></label><input type="text" class="form-input" id="lotProd" required placeholder="Nom du produit"></div>';
  h += '<div class="form-group"><label class="form-label">N¬∞ de lot <span class="req">*</span></label><input type="text" class="form-input" id="lotNum" required placeholder="Ex: LOT-2026-001" style="text-transform:uppercase"></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Fournisseur</label><select class="form-select" id="lotSupp"><option value="">S√©lectionner...</option>';
  S.siteConfig.suppliers.forEach(function(s) { h += '<option value="' + esc(s.name) + '">' + esc(s.name) + '</option>'; });
  h += '</select></div>';
  h += '<div class="form-group"><label class="form-label">DLC</label><input type="date" class="form-input" id="lotDlc"></div></div>';

  // Photo zone Lot
  h += '<div class="form-group"><label class="form-label">üì∏ Photo de l\'√©tiquette</label>';
  if (S.photoLotData) {
    h += '<div style="text-align:center;padding:12px;border:2px solid var(--success);border-radius:var(--radius);background:var(--success-bg)"><img src="' + S.photoLotData + '" class="photo-preview"><br><button type="button" class="btn btn-ghost btn-sm" onclick="clearPhotoLot()">‚úï Supprimer la photo</button></div>';
  } else {
    h += '<label class="photo-box" for="photoLotInput"><div class="photo-icon">üì∑</div><div class="photo-text">Prendre une photo de l\'√©tiquette</div><div class="photo-hint">Le N¬∞ de lot sera d√©tect√© si possible</div></label><input type="file" id="photoLotInput" accept="image/*" capture="environment" onchange="handlePhotoFor(\'photoLotInput\',\'lot\')" style="display:none">';
  }
  h += '</div>';

  h += '<div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="lotNotes" rows="2" placeholder="Observations..."></textarea></div>';
  h += '<button type="submit" class="btn btn-success btn-block">‚úì Enregistrer le lot</button></form></div></div>';

  // List
  h += '<div class="card"><div class="card-header">üì¶ Lots enregistr√©s <span class="badge badge-gray" style="margin-left:auto">' + S.data.lots.length + '</span></div>';
  if (S.data.lots.length === 0) {
    h += '<div class="card-body"><div class="empty"><div class="empty-icon">üì¶</div><div class="empty-title">Aucun lot enregistr√©</div></div></div>';
  } else {
    S.data.lots.forEach(function(l) {
      h += '<div class="list-item"><div class="list-icon" style="background:var(--primary-light)">üì¶</div><div class="list-content"><div class="list-title">' + esc(l.product_name) + ' ‚Äî <span style="font-family:monospace">' + esc(l.lot_number) + '</span></div><div class="list-sub">';
      if (l.supplier_name) h += 'üè≠ ' + esc(l.supplier_name) + ' ¬∑ ';
      if (l.dlc_date) h += 'üìÖ DLC: ' + fmtD(l.dlc_date) + ' ¬∑ ';
      h += '‚è∞ ' + fmtDT(l.recorded_at) + ' par ' + esc(l.recorded_by_name);
      h += '</div></div><div class="list-actions"><button class="btn btn-ghost btn-sm" onclick="deleteLot(\'' + l.id + '\')">üóëÔ∏è</button></div></div>';
    });
  }
  h += '</div>';

  return h;
}

// renderLots kept as alias for backward compatibility
function renderLots() { S.dlcTab = 'lots'; return renderDLC(); }

// =====================================================================
// PAGE: ORDERS
// =====================================================================

function renderOrders() {
  var h = '';
  if (!S.ordersTab) S.ordersTab = 'active';

  // Tabs
  h += '<div class="tabs" style="margin-bottom:16px">';
  h += '<button class="tab' + (S.ordersTab==='active'?' active':'') + '" onclick="S.ordersTab=\'active\';render()">üõí Commandes en cours</button>';
  h += '<button class="tab' + (S.ordersTab==='history'?' active':'') + '" onclick="S.ordersTab=\'history\';loadOrderHistory()">üìã Historique</button>';
  h += '</div>';

  if (S.ordersTab === 'active') {
    h += renderOrdersActive();
  } else {
    h += renderOrdersHistory();
  }

  return h;
}

function renderOrdersActive() {
  var h = '';

  // Form
  h += '<div class="card"><div class="card-header">‚ûï Nouvelle commande</div><div class="card-body"><form onsubmit="handleOrder(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Produit <span class="req">*</span></label><input type="text" class="form-input" id="ordProd" required placeholder="Nom du produit"></div>';
  h += '<div class="form-group"><label class="form-label">Quantit√©</label><div style="display:flex;gap:8px"><input type="number" class="form-input" id="ordQty" value="1" min="0.1" step="0.1" style="flex:1"><select class="form-select" id="ordUnit" style="flex:1"><option>unit√©</option><option>kg</option><option>L</option><option>carton</option><option>paquet</option></select></div></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Fournisseur <span class="req">*</span></label><select class="form-select" id="ordSupp" required><option value="">S√©lectionner...</option>';
  S.siteConfig.suppliers.forEach(function(s) { h += '<option value="' + esc(s.name) + '">' + esc(s.name) + '</option>'; });
  h += '</select></div><div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="ordNotes" placeholder="Optionnel"></div></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Ajouter √† la commande</button></form></div></div>';

  // √Ä commander ‚Äî group√© par fournisseur
  var toOrder = S.data.orders.filter(function(o) { return o.status === 'to_order'; });
  var ordered = S.data.orders.filter(function(o) { return o.status === 'ordered'; });

  if (toOrder.length > 0) {
    var bySupplier = {};
    toOrder.forEach(function(o) {
      var key = o.supplier_name || '‚Äî Sans fournisseur ‚Äî';
      if (!bySupplier[key]) bySupplier[key] = [];
      bySupplier[key].push(o);
    });

    h += '<div class="card" style="border-left:4px solid var(--warning)"><div class="card-header">üõí √Ä commander <span class="badge badge-yellow" style="margin-left:auto">' + toOrder.length + '</span></div><div class="card-body">';
    
    Object.keys(bySupplier).forEach(function(supplier) {
      var items = bySupplier[supplier];
      h += '<div style="margin-bottom:20px;padding:16px;background:var(--gray-light);border-radius:8px">';
      h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--primary)">';
      h += '<h4 style="margin:0;font-size:15px;font-weight:700">üè≠ ' + esc(supplier) + ' <span class="badge badge-blue">' + items.length + ' article' + (items.length > 1 ? 's' : '') + '</span></h4>';
      h += '<button class="btn btn-primary btn-sm" onclick="markSupplierOrdered(\'' + esc(supplier).replace(/'/g,'\\\'') + '\')">üìû Tout command√©</button>';
      h += '</div>';
      
      items.forEach(function(o) {
        h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.06)">';
        h += '<div><strong>' + esc(o.product_name) + '</strong><span style="color:var(--gray);font-size:13px;margin-left:8px">' + (o.quantity||1) + ' ' + esc(o.unit||'unit√©') + '</span>';
        if (o.notes) h += '<span style="color:var(--gray);font-size:12px;margin-left:6px">(' + esc(o.notes) + ')</span>';
        h += '</div>';
        h += '<div style="display:flex;gap:4px">';
        h += '<button class="btn btn-primary btn-sm" onclick="updateOrderStatus(\'' + o.id + '\',\'ordered\')" title="Command√©">‚úì</button>';
        h += '<button class="btn btn-ghost btn-sm" onclick="deleteOrder(\'' + o.id + '\')" title="Supprimer">üóëÔ∏è</button>';
        h += '</div></div>';
      });
      h += '</div>';
    });
    h += '</div></div>';
  }

  // Command√© ‚Äî en attente de livraison
  if (ordered.length > 0) {
    var bySupplier2 = {};
    ordered.forEach(function(o) {
      var key = o.supplier_name || '‚Äî Sans fournisseur ‚Äî';
      if (!bySupplier2[key]) bySupplier2[key] = [];
      bySupplier2[key].push(o);
    });

    h += '<div class="card" style="border-left:4px solid var(--primary)"><div class="card-header">üì¶ En attente de livraison <span class="badge badge-blue" style="margin-left:auto">' + ordered.length + '</span></div><div class="card-body">';
    
    Object.keys(bySupplier2).forEach(function(supplier) {
      var items = bySupplier2[supplier];
      h += '<div style="margin-bottom:16px">';
      h += '<h4 style="margin:0 0 8px;font-size:14px;font-weight:700;color:var(--primary)">üè≠ ' + esc(supplier) + '</h4>';
      items.forEach(function(o) {
        h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.06)">';
        h += '<div><strong>' + esc(o.product_name) + '</strong><span style="color:var(--gray);font-size:13px;margin-left:8px">' + (o.quantity||1) + ' ' + esc(o.unit||'unit√©') + '</span>';
        h += '<div style="font-size:12px;color:var(--gray)">Command√© le ' + fmtD(o.ordered_at) + '</div></div>';
        h += '<button class="btn btn-success btn-sm" onclick="openReceiveModal(\'' + o.id + '\',\'' + esc(o.product_name).replace(/'/g,'\\\'') + '\')">‚úÖ R√©ceptionner</button>';
        h += '</div>';
      });
      h += '</div>';
    });
    h += '</div></div>';
  }

  if (toOrder.length === 0 && ordered.length === 0) {
    h += '<div class="card"><div class="card-body"><div class="empty"><div class="empty-icon">üõí</div><div class="empty-title">Aucune commande en cours</div><div class="empty-text">Ajoutez des produits √† commander ci-dessus.</div></div></div></div>';
  }

  return h;
}

function renderOrdersHistory() {
  var h = '';
  h += '<div class="card"><div class="card-header">üìã Commandes re√ßues</div><div class="card-body" id="orderHistoryContainer"><div style="text-align:center;padding:20px"><div class="loading"></div></div></div></div>';
  setTimeout(function() { loadAndRenderOrderHistory(); }, 50);
  return h;
}

async function loadOrderHistory() {
  S.ordersTab = 'history';
  render();
}

async function loadAndRenderOrderHistory() {
  var container = $('orderHistoryContainer');
  if (!container) return;
  
  var r = await sb.from('orders').select('*').eq('site_id', S.currentSiteId).eq('status', 'received').order('received_at', {ascending:false}).limit(50);
  var received = r.data || [];

  if (received.length === 0) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><div class="empty-title">Aucune commande re√ßue</div></div>';
    return;
  }

  // Group by supplier
  var bySupplier = {};
  received.forEach(function(o) {
    var key = o.supplier_name || '‚Äî Sans fournisseur ‚Äî';
    if (!bySupplier[key]) bySupplier[key] = [];
    bySupplier[key].push(o);
  });

  var html = '';
  Object.keys(bySupplier).forEach(function(supplier) {
    var items = bySupplier[supplier];
    html += '<div style="margin-bottom:20px">';
    html += '<h4 style="font-size:14px;font-weight:700;margin:0 0 10px;padding-bottom:6px;border-bottom:2px solid var(--success)">üè≠ ' + esc(supplier) + ' <span class="badge badge-green">' + items.length + ' livraison' + (items.length > 1 ? 's' : '') + '</span></h4>';
    
    items.forEach(function(o) {
      html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(0,0,0,0.06);flex-wrap:wrap;gap:8px">';
      html += '<div><strong>' + esc(o.product_name) + '</strong> ‚Äî ' + (o.quantity||1) + ' ' + esc(o.unit||'unit√©');
      html += '<div style="font-size:12px;color:var(--gray)">Re√ßu le ' + fmtDT(o.received_at) + '</div></div>';
      html += '<div style="display:flex;gap:6px;align-items:center">';
      if (o.bl_photo) {
        html += '<button class="btn btn-ghost btn-sm" onclick="viewBLPhoto(\'' + o.id + '\')">üì∏ Voir BL</button>';
      } else {
        html += '<span class="badge badge-yellow" style="font-size:11px">Pas de BL</span>';
        html += '<button class="btn btn-ghost btn-sm" onclick="openReceiveModal(\'' + o.id + '\',\'' + esc(o.product_name).replace(/'/g,'\\\'') + '\',true)">üì∏ Ajouter</button>';
      }
      html += '</div></div>';
    });
    html += '</div>';
  });

  container.innerHTML = html;
}

// Modal de r√©ception avec photo BL
window.openReceiveModal = function(orderId, productName, photoOnly) {
  var title = photoOnly ? 'üì∏ Ajouter photo BL/Facture' : '‚úÖ R√©ception : ' + productName;
  var html = '<div class="modal-header"><div class="modal-title">' + title + '</div><button class="modal-close" onclick="closeModal()">‚úï</button></div>';
  html += '<div class="modal-body">';
  if (!photoOnly) {
    html += '<p style="margin-bottom:12px;font-size:14px">Confirmez la r√©ception de <strong>' + productName + '</strong>.</p>';
  }
  html += '<div class="form-group"><label class="form-label">üì∏ Photo du BL ou de la facture <span style="font-size:12px;color:var(--gray)">(recommand√©)</span></label>';
  html += '<label class="photo-box" for="blPhotoInput" id="blPhotoPreviewBox"><div class="photo-icon">üì∑</div><div class="photo-text">Prendre une photo du bon de livraison</div><div class="photo-hint">Servira de preuve de r√©ception</div></label>';
  html += '<input type="file" id="blPhotoInput" accept="image/*" capture="environment" onchange="previewBLPhoto()" style="display:none">';
  html += '<div id="blPhotoPreview" style="display:none;text-align:center;padding:12px;border:2px solid var(--success);border-radius:8px;background:var(--success-bg)"><img id="blPhotoImg" class="photo-preview" style="max-width:300px"><br><button type="button" class="btn btn-ghost btn-sm" onclick="clearBLPhoto()">‚úï Supprimer</button></div>';
  html += '</div>';
  html += '<div class="form-group"><label class="form-label">Notes de r√©ception</label><input type="text" class="form-input" id="receiveNotes" placeholder="Ex: Tout conforme, manque 2 cartons..."></div>';
  html += '</div>';
  html += '<div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal()">Annuler</button>';
  html += '<button class="btn btn-success btn-lg" onclick="confirmReceive(\'' + orderId + '\',' + (photoOnly ? 'true' : 'false') + ')">‚úÖ ' + (photoOnly ? 'Enregistrer' : 'Confirmer la r√©ception') + '</button></div>';
  openModal(html);
};

window.previewBLPhoto = function() {
  var input = document.getElementById('blPhotoInput');
  if (!input || !input.files || !input.files[0]) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    S._blPhotoData = e.target.result;
    document.getElementById('blPhotoPreviewBox').style.display = 'none';
    var preview = document.getElementById('blPhotoPreview');
    preview.style.display = 'block';
    document.getElementById('blPhotoImg').src = e.target.result;
  };
  reader.readAsDataURL(input.files[0]);
};

window.clearBLPhoto = function() {
  S._blPhotoData = null;
  document.getElementById('blPhotoPreviewBox').style.display = '';
  document.getElementById('blPhotoPreview').style.display = 'none';
};

window.confirmReceive = async function(orderId, photoOnly) {
  try {
    var upd = {};
    if (!photoOnly) {
      upd.status = 'received';
      upd.received_at = new Date().toISOString();
    }
    var notes = document.getElementById('receiveNotes');
    if (notes && notes.value) upd.receive_notes = notes.value;
    if (S._blPhotoData) upd.bl_photo = S._blPhotoData;
    
    await sb.from('orders').update(upd).eq('id', orderId);
    S._blPhotoData = null;
    closeModal();
    await loadSiteData();
    render();
    alert('‚úÖ ' + (photoOnly ? 'Photo enregistr√©e !' : 'R√©ception confirm√©e !'));
  } catch(e) { alert('‚ùå Erreur: ' + (e.message||e)); }
};

window.markSupplierOrdered = async function(supplierName) {
  if (!confirm('Marquer toutes les commandes de ' + supplierName + ' comme command√©es ?')) return;
  var toMark = S.data.orders.filter(function(o) { return o.status === 'to_order' && (o.supplier_name || '‚Äî Sans fournisseur ‚Äî') === supplierName; });
  for (var i = 0; i < toMark.length; i++) {
    await sb.from('orders').update({ status: 'ordered' }).eq('id', toMark[i].id);
  }
  await loadSiteData();
  render();
  alert('‚úÖ ' + toMark.length + ' commande(s) marqu√©e(s) comme command√©e(s) !');
};

window.viewBLPhoto = function(orderId) {
  // Load the order's BL photo
  sb.from('orders').select('bl_photo,product_name').eq('id', orderId).single().then(function(r) {
    if (r.data && r.data.bl_photo) {
      var html = '<div class="modal-header"><div class="modal-title">üì∏ BL : ' + esc(r.data.product_name) + '</div><button class="modal-close" onclick="closeModal()">‚úï</button></div>';
      html += '<div class="modal-body" style="text-align:center"><img src="' + r.data.bl_photo + '" style="max-width:100%;max-height:70vh;border-radius:8px"></div>';
      openModal(html);
    } else {
      alert('Aucune photo disponible.');
    }
  });
};

// =====================================================================
// PAGE: CONSIGNES
// =====================================================================

function renderConsignes() {
  var h = '';

  h += '<div class="card"><div class="card-header">‚ûï Nouvelle consigne</div><div class="card-body"><form onsubmit="handleConsigne(event)">';
  h += '<div class="form-group"><label class="form-label">Message <span class="req">*</span></label><textarea class="form-textarea" id="conMsg" rows="3" required placeholder="√âcrire une consigne pour l\'√©quipe..."></textarea></div>';
  h += '<div class="form-group"><label class="form-label">Priorit√©</label><select class="form-select" id="conPrio"><option value="normal">üü¢ Normal</option><option value="urgent">üî¥ Urgent</option></select></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Publier</button></form></div></div>';

  h += '<div class="card"><div class="card-header">üí¨ Consignes r√©centes</div>';
  if (S.data.consignes.length === 0) {
    h += '<div class="card-body"><div class="empty"><div class="empty-icon">üí¨</div><div class="empty-title">Aucune consigne</div></div></div>';
  } else {
    S.data.consignes.forEach(function(c) {
      var border = c.priority === 'urgent' ? 'var(--danger)' : 'var(--gray-border)';
      h += '<div class="list-item" style="border-left:3px solid ' + border + '"><div class="list-content"><div class="list-title">' + (c.priority === 'urgent' ? 'üî¥ ' : '') + esc(c.message) + '</div><div class="list-sub">Par ' + esc(c.created_by_name) + ' ‚Äî ' + fmtDT(c.created_at) + '</div></div>';
      if (isManager()) h += '<div class="list-actions"><button class="btn btn-ghost btn-sm" onclick="deleteConsigne(\'' + c.id + '\')">üóëÔ∏è</button></div>';
      h += '</div>';
    });
  }
  h += '</div>';

  return h;
}

// =====================================================================
// PAGE: REPORTS
// =====================================================================

function renderReports() {
  var h = '';
  h += '<div class="card"><div class="card-header">üìÑ G√©n√©ration de rapports</div><div class="card-body">';
  h += '<div style="display:flex;flex-direction:column;gap:12px">';
  h += '<button class="btn btn-primary btn-lg" onclick="generateDailyPDF()">üìã Rapport journalier (Temp√©ratures)</button>';
  h += '<p style="font-size:13px;color:var(--gray)">G√©n√®re un rapport PDF des relev√©s de temp√©rature du jour avec signature, pr√™t pour impression ou archivage.</p>';
  h += '</div></div></div>';

  h += '<div class="card"><div class="card-header">üìä Historique</div><div class="card-body">';
  h += '<p style="font-size:14px;color:var(--gray)">Les rapports mensuels et les exports d√©taill√©s seront disponibles dans une prochaine mise √† jour.</p>';
  h += '</div></div>';

  return h;
}

// =====================================================================
// PAGE: SETTINGS (Manager/Admin)
// =====================================================================

function renderSettings() {
  if (!isManager()) {
    return '<div class="card"><div class="card-body"><div class="empty"><div class="empty-icon">üîí</div><div class="empty-title">Acc√®s restreint</div></div></div></div>';
  }

  var h = '';
  h += '<div class="tabs">';
  ['equipment','products','suppliers','modules'].forEach(function(t) {
    var labels = {equipment:'‚ùÑÔ∏è √âquipements',products:'üçΩÔ∏è Produits',suppliers:'üè≠ Fournisseurs',modules:'üì¶ Modules'};
    h += '<button class="tab' + (S.settingsTab===t?' active':'') + '" onclick="S.settingsTab=\'' + t + '\';render()">' + labels[t] + '</button>';
  });
  h += '</div>';

  if (S.settingsTab === 'equipment') h += renderSettingsEquipment();
  else if (S.settingsTab === 'products') h += renderSettingsProducts();
  else if (S.settingsTab === 'suppliers') h += renderSettingsSuppliers();
  else if (S.settingsTab === 'modules') h += renderSettingsModules();

  return h;
}

function renderSettingsEquipment() {
  var h = '<div class="card"><div class="card-header">‚ûï Ajouter un √©quipement</div><div class="card-body"><form onsubmit="handleAddEquip(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Nom <span class="req">*</span></label><input type="text" class="form-input" id="eqName" required placeholder="Ex: Frigo cuisine"></div>';
  h += '<div class="form-group"><label class="form-label">Type</label><select class="form-select" id="eqType"><option value="fridge">Frigo</option><option value="freezer">Cong√©lateur</option><option value="hot">Chaud</option><option value="other">Autre</option></select></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Temp. min ¬∞C</label><input type="number" step="0.1" class="form-input" id="eqMin" value="0"></div>';
  h += '<div class="form-group"><label class="form-label">Temp. max ¬∞C</label><input type="number" step="0.1" class="form-input" id="eqMax" value="4"></div></div>';
  h += '<div class="form-group"><label class="form-label">Emoji</label><input type="text" class="form-input" id="eqEmoji" value="‚ùÑÔ∏è" maxlength="4"></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Ajouter</button></form></div></div>';

  h += '<div class="card"><div class="card-header">√âquipements actifs</div>';
  S.siteConfig.equipment.forEach(function(e) {
    h += '<div class="list-item"><div class="list-icon" style="background:var(--primary-light)">' + e.emoji + '</div><div class="list-content"><div class="list-title">' + esc(e.name) + '</div><div class="list-sub">' + e.temp_min + '¬∞C ‚Üí ' + e.temp_max + '¬∞C ¬∑ ' + ({fridge:'Frigo',freezer:'Cong√©lateur',hot:'Chaud',other:'Autre'}[e.type] || e.type) + '</div></div><div class="list-actions"><button class="btn btn-danger btn-sm" onclick="deleteEquipment(\'' + e.id + '\')">üóëÔ∏è</button></div></div>';
  });
  if (S.siteConfig.equipment.length === 0) h += '<div class="card-body"><div class="empty"><div class="empty-title">Aucun √©quipement</div></div></div>';
  h += '</div>';
  return h;
}

function renderSettingsProducts() {
  var h = '<div class="card"><div class="card-header">‚ûï Ajouter un produit</div><div class="card-body"><form onsubmit="handleAddProd(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Nom <span class="req">*</span></label><input type="text" class="form-input" id="prName" required placeholder="Ex: Saumon frais"></div>';
  h += '<div class="form-group"><label class="form-label">Cat√©gorie</label><select class="form-select" id="prCat"><option value="frigo">Frigo</option><option value="congel">Cong√©lateur</option><option value="chaud">Chaud</option><option value="autre">Autre</option></select></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Temp. min ¬∞C</label><input type="number" step="0.1" class="form-input" id="prMin" value="0"></div>';
  h += '<div class="form-group"><label class="form-label">Temp. max ¬∞C</label><input type="number" step="0.1" class="form-input" id="prMax" value="4"></div></div>';
  h += '<div class="form-group"><label class="form-label">Emoji</label><input type="text" class="form-input" id="prEmoji" value="üì¶" maxlength="4"></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Ajouter</button></form></div></div>';

  h += '<div class="card"><div class="card-header">Produits actifs</div>';
  S.siteConfig.products.forEach(function(p) {
    h += '<div class="list-item"><div class="list-icon" style="background:var(--success-bg)">' + p.emoji + '</div><div class="list-content"><div class="list-title">' + esc(p.name) + '</div><div class="list-sub">' + p.temp_min + '¬∞C ‚Üí ' + p.temp_max + '¬∞C ¬∑ ' + ({frigo:'Frigo',congel:'Cong√©lateur',chaud:'Chaud',autre:'Autre'}[p.category] || p.category) + '</div></div><div class="list-actions"><button class="btn btn-danger btn-sm" onclick="deleteProduct(\'' + p.id + '\')">üóëÔ∏è</button></div></div>';
  });
  if (S.siteConfig.products.length === 0) h += '<div class="card-body"><div class="empty"><div class="empty-title">Aucun produit</div></div></div>';
  h += '</div>';
  return h;
}

function renderSettingsSuppliers() {
  var h = '<div class="card"><div class="card-header">‚ûï Ajouter un fournisseur</div><div class="card-body"><form onsubmit="handleAddSupp(event)">';
  h += '<div class="form-group"><label class="form-label">Nom <span class="req">*</span></label><input type="text" class="form-input" id="spName" required placeholder="Ex: Brake France"></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">T√©l√©phone</label><input type="tel" class="form-input" id="spPhone" placeholder="0612345678"></div>';
  h += '<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="spEmail" placeholder="contact@four.com"></div></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Ajouter</button></form></div></div>';

  h += '<div class="card"><div class="card-header">Fournisseurs actifs</div>';
  S.siteConfig.suppliers.forEach(function(s) {
    h += '<div class="list-item"><div class="list-icon" style="background:var(--warning-bg)">üè≠</div><div class="list-content"><div class="list-title">' + esc(s.name) + '</div><div class="list-sub">' + (s.phone ? 'üìû ' + esc(s.phone) + ' ' : '') + (s.email ? '‚úâÔ∏è ' + esc(s.email) : '') + '</div></div><div class="list-actions"><button class="btn btn-danger btn-sm" onclick="deleteSupplier(\'' + s.id + '\')">üóëÔ∏è</button></div></div>';
  });
  if (S.siteConfig.suppliers.length === 0) h += '<div class="card-body"><div class="empty"><div class="empty-title">Aucun fournisseur</div></div></div>';
  h += '</div>';
  return h;
}

function renderSettingsModules() {
  var modules = [
    {key:'temperatures',label:'üå°Ô∏è Temp√©ratures',desc:'Relev√©s de temp√©rature des √©quipements et produits'},
    {key:'dlc',label:'üìÖ Contr√¥le DLC',desc:'Suivi des dates limites de consommation'},
    {key:'lots',label:'üì¶ Tra√ßabilit√©',desc:'Enregistrement des num√©ros de lots'},
    {key:'orders',label:'üõí Commandes',desc:'Gestion des commandes fournisseurs'},
    {key:'consignes',label:'üí¨ Consignes',desc:'Communication inter-√©quipes'},
    {key:'viennoiseries',label:'ü•ê Viennoiseries',desc:'Calculateur petit-d√©jeuner'}
  ];

  var h = '<div class="card"><div class="card-header">üì¶ Modules actifs pour ce site</div><div class="card-body">';
  modules.forEach(function(m) {
    var enabled = moduleEnabled(m.key);
    h += '<div class="list-item"><div class="list-content"><div class="list-title">' + m.label + '</div><div class="list-sub">' + m.desc + '</div></div>';
    h += '<label class="toggle"><input type="checkbox" ' + (enabled?'checked':'') + ' onchange="toggleModule(\'' + m.key + '\',this.checked)"><span class="toggle-slider"></span></label></div>';
  });
  h += '</div></div>';

  // Config temp√©rature
  if (moduleEnabled('temperatures')) {
    var site = currentSite();
    var servicesPerDay = (site && site.services_per_day) || 1;
    h += '<div class="card"><div class="card-header">üå°Ô∏è Configuration temp√©ratures</div><div class="card-body">';
    h += '<div class="form-group"><label class="form-label">Nombre de services par jour</label>';
    h += '<div style="display:flex;align-items:center;gap:12px">';
    h += '<select class="form-select" style="width:200px" onchange="updateSiteConfig(\'services_per_day\',parseInt(this.value))">';
    for (var i = 1; i <= 4; i++) {
      h += '<option value="' + i + '"' + (servicesPerDay===i?' selected':'') + '>' + i + ' service' + (i>1?'s':'') + ' / jour</option>';
    }
    h += '</select>';
    h += '<span style="font-size:13px;color:var(--gray)">Chaque service n√©cessite un relev√© complet de tous les √©quipements et produits</span>';
    h += '</div></div>';
    h += '</div></div>';
  }

  return h;
}

// =====================================================================
// PAGE: SITE MANAGEMENT (Super Admin)
// =====================================================================

function renderSiteManagement() {
  if (!isSuperAdmin()) {
    return '<div class="card"><div class="card-body"><div class="empty"><div class="empty-icon">üîí</div><div class="empty-title">Acc√®s Super Admin requis</div></div></div></div>';
  }

  var h = '';

  // Create site form (collapsible)
  h += '<div class="card"><div class="card-header" style="cursor:pointer" onclick="var el=document.getElementById(\'newSiteForm\');el.style.display=el.style.display===\'none\'?\'block\':\'none\'">‚ûï Cr√©er un nouveau site <span style="float:right;font-size:12px;color:var(--gray)">‚ñº</span></div><div class="card-body" id="newSiteForm" style="display:none"><form onsubmit="handleCreateSite(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Nom <span class="req">*</span></label><input type="text" class="form-input" id="sName" required placeholder="Ex: B&B H√¥tel Brest"></div>';
  h += '<div class="form-group"><label class="form-label">Type</label><select class="form-select" id="sType"><option value="hotel">üè® H√¥tel</option><option value="restaurant">üçΩÔ∏è Restaurant</option><option value="cuisine_centrale">üè≠ Cuisine centrale</option><option value="autre">üè¢ Autre</option></select></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Adresse</label><input type="text" class="form-input" id="sAddr" placeholder="123 rue Principale"></div>';
  h += '<div class="form-group"><label class="form-label">Ville</label><input type="text" class="form-input" id="sCity" placeholder="Brest"></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">T√©l√©phone</label><input type="tel" class="form-input" id="sPhone"></div>';
  h += '<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="sEmail"></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">N¬∞ Agr√©ment</label><input type="text" class="form-input" id="sAgr"></div>';
  h += '<div class="form-group"><label class="form-label">Responsable</label><input type="text" class="form-input" id="sResp"></div></div>';
  h += '<button type="submit" class="btn btn-success btn-lg">‚úì Cr√©er le site</button></form></div></div>';

  // Sites list with details
  h += '<div class="card"><div class="card-header">üè¢ Tous les sites <span class="badge badge-blue" style="margin-left:auto">' + S.sites.length + '</span></div>';
  if (S.sites.length === 0) {
    h += '<div class="card-body"><div class="empty"><div class="empty-icon">üè¢</div><div class="empty-title">Aucun site</div></div></div>';
  } else {
    S.sites.forEach(function(s) {
      var typeEmoji = {hotel:'üè®',restaurant:'üçΩÔ∏è',cuisine_centrale:'üè≠',autre:'üè¢'}[s.type] || 'üè¢';
      h += '<div class="list-item" style="flex-wrap:wrap">';
      h += '<div class="list-icon" style="background:var(--primary-light)">' + typeEmoji + '</div>';
      h += '<div class="list-content"><div class="list-title">' + esc(s.name) + '</div><div class="list-sub">' + (s.address ? esc(s.address) : '') + (s.city ? ', ' + esc(s.city) : '') + (s.responsable ? ' ‚Äî ' + esc(s.responsable) : '') + '</div></div>';
      h += '<div class="list-actions">';
      h += '<button class="btn btn-primary btn-sm" onclick="openEditSiteModal(\'' + s.id + '\')">‚úèÔ∏è Modifier</button>';
      h += '<button class="btn btn-warning btn-sm" onclick="openSiteAccessModal(\'' + s.id + '\')">üë• Acc√®s</button>';
      h += '<button class="btn btn-ghost btn-sm" onclick="switchSite(\'' + s.id + '\');navigate(\'settings\')">‚öôÔ∏è Config</button>';
      h += '<button class="btn btn-danger btn-sm" onclick="deleteSite(\'' + s.id + '\')">üóëÔ∏è</button>';
      h += '</div></div>';
    });
  }
  h += '</div>';

  return h;
}

// Modal : Modifier un site
window.openEditSiteModal = function(siteId) {
  var site = S.sites.find(function(s){return s.id===siteId;});
  if (!site) return;
  var html = '<div class="modal-header"><div class="modal-title">‚úèÔ∏è Modifier : ' + esc(site.name) + '</div><button class="modal-close" onclick="closeModal()">‚úï</button></div>';
  html += '<div class="modal-body"><form onsubmit="handleUpdateSite(event,\'' + siteId + '\')">';
  html += '<div class="form-row"><div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="esName" value="' + esc(site.name) + '" required></div>';
  html += '<div class="form-group"><label class="form-label">Type</label><select class="form-select" id="esType"><option value="hotel"' + (site.type==='hotel'?' selected':'') + '>üè® H√¥tel</option><option value="restaurant"' + (site.type==='restaurant'?' selected':'') + '>üçΩÔ∏è Restaurant</option><option value="cuisine_centrale"' + (site.type==='cuisine_centrale'?' selected':'') + '>üè≠ Cuisine centrale</option><option value="autre"' + (site.type==='autre'?' selected':'') + '>üè¢ Autre</option></select></div></div>';
  html += '<div class="form-row"><div class="form-group"><label class="form-label">Adresse</label><input type="text" class="form-input" id="esAddr" value="' + esc(site.address||'') + '"></div>';
  html += '<div class="form-group"><label class="form-label">Ville</label><input type="text" class="form-input" id="esCity" value="' + esc(site.city||'') + '"></div></div>';
  html += '<div class="form-row"><div class="form-group"><label class="form-label">T√©l√©phone</label><input type="tel" class="form-input" id="esPhone" value="' + esc(site.phone||'') + '"></div>';
  html += '<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="esEmail" value="' + esc(site.email||'') + '"></div></div>';
  html += '<div class="form-row"><div class="form-group"><label class="form-label">N¬∞ Agr√©ment</label><input type="text" class="form-input" id="esAgr" value="' + esc(site.agrement||'') + '"></div>';
  html += '<div class="form-group"><label class="form-label">Responsable</label><input type="text" class="form-input" id="esResp" value="' + esc(site.responsable||'') + '"></div></div>';
  html += '<button type="submit" class="btn btn-primary btn-lg" style="margin-top:12px">‚úì Enregistrer</button></form></div>';
  openModal(html);
};

window.handleUpdateSite = async function(e, siteId) {
  e.preventDefault();
  await updateSite(siteId, {
    name: $('esName').value, type: $('esType').value,
    address: $('esAddr').value, city: $('esCity').value,
    phone: $('esPhone').value, email: $('esEmail').value,
    agrement: $('esAgr').value, responsable: $('esResp').value
  });
  closeModal();
  alert('‚úÖ Site mis √† jour !');
};

// Modal : G√©rer les acc√®s d'un site
window.openSiteAccessModal = async function(siteId) {
  var site = S.sites.find(function(s){return s.id===siteId;});
  if (!site) return;

  var html = '<div class="modal-header"><div class="modal-title">üë• Acc√®s : ' + esc(site.name) + '</div><button class="modal-close" onclick="closeModal()">‚úï</button></div>';
  html += '<div class="modal-body" id="siteAccessBody"><div style="text-align:center;padding:20px"><div class="loading"></div></div></div>';
  openModal(html);

  // Charger les utilisateurs du site
  var siteUsers = await loadSiteUsers(siteId);
  var allUsers = await loadAllUsers();

  var body = '';

  // Utilisateurs actuels du site
  body += '<h3 style="font-size:15px;font-weight:700;margin-bottom:12px">Membres actuels</h3>';
  if (siteUsers.length === 0) {
    body += '<p style="color:var(--gray);font-size:13px;margin-bottom:16px">Aucun utilisateur assign√©.</p>';
  } else {
    body += '<table class="data-table" style="margin-bottom:16px"><thead><tr><th>Nom</th><th>Email</th><th>R√¥le global</th><th>R√¥le site</th><th>Actions</th></tr></thead><tbody>';
    siteUsers.forEach(function(us) {
      var p = us.profiles;
      if (!p) return;
      var globalRole = {super_admin:'üëë Super Admin',manager:'üëî G√©rant',employee:'üë∑ Employ√©'}[p.role] || p.role;
      var siteRoleLabel = {admin:'üîë Admin',manager:'üëî G√©rant',employee:'üë∑ Employ√©'}[us.site_role] || us.site_role;
      body += '<tr><td>' + esc(p.full_name||'‚Äî') + '</td><td style="font-size:12px">' + esc(p.email) + '</td><td>' + globalRole + '</td><td>';
      body += '<select onchange="changeSiteRole(\'' + p.id + '\',\'' + siteId + '\',this.value)" style="padding:4px 8px;border-radius:4px;border:1px solid #ddd">';
      body += '<option value="employee"' + (us.site_role==='employee'?' selected':'') + '>Employ√©</option>';
      body += '<option value="manager"' + (us.site_role==='manager'?' selected':'') + '>G√©rant</option>';
      body += '<option value="admin"' + (us.site_role==='admin'?' selected':'') + '>Admin</option>';
      body += '</select></td>';
      body += '<td><button class="btn btn-danger btn-sm" onclick="removeSiteAccess(\'' + p.id + '\',\'' + siteId + '\')">Retirer</button></td></tr>';
    });
    body += '</tbody></table>';
  }

  // Ajouter un utilisateur existant
  var existingIds = siteUsers.map(function(us){return us.user_id;});
  var available = allUsers.filter(function(u){return existingIds.indexOf(u.id) === -1;});

  body += '<h3 style="font-size:15px;font-weight:700;margin:16px 0 12px">Ajouter un membre</h3>';
  if (available.length === 0) {
    body += '<p style="color:var(--gray);font-size:13px">Tous les utilisateurs sont d√©j√† assign√©s √† ce site.</p>';
  } else {
    body += '<div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">';
    body += '<select id="addUserSelect" class="form-select" style="flex:1;min-width:200px">';
    available.forEach(function(u) {
      var rl = {super_admin:'üëë',manager:'üëî',employee:'üë∑'}[u.role] || '';
      body += '<option value="' + u.id + '">' + rl + ' ' + esc(u.full_name||u.email) + ' (' + esc(u.email) + ')</option>';
    });
    body += '</select>';
    body += '<select id="addUserRole" class="form-select" style="width:140px"><option value="employee">Employ√©</option><option value="manager">G√©rant</option><option value="admin">Admin</option></select>';
    body += '<button class="btn btn-success btn-sm" onclick="addSiteAccess(\'' + siteId + '\')">+ Ajouter</button>';
    body += '</div>';
  }

  $('siteAccessBody').innerHTML = body;
};

window.changeSiteRole = async function(userId, siteId, newRole) {
  try {
    await assignUserToSite(userId, siteId, newRole);
    alert('‚úÖ R√¥le modifi√© !');
  } catch(e) { alert('‚ùå Erreur: ' + (e.message||e)); }
};

window.removeSiteAccess = async function(userId, siteId) {
  if (!confirm('Retirer cet utilisateur du site ?')) return;
  try {
    await removeUserFromSite(userId, siteId);
    alert('‚úÖ Utilisateur retir√© du site');
    openSiteAccessModal(siteId); // Recharger
  } catch(e) { alert('‚ùå Erreur: ' + (e.message||e)); }
};

window.addSiteAccess = async function(siteId) {
  var userId = $('addUserSelect').value;
  var role = $('addUserRole').value;
  if (!userId) return;
  try {
    await assignUserToSite(userId, siteId, role);
    alert('‚úÖ Utilisateur ajout√© au site !');
    openSiteAccessModal(siteId); // Recharger
  } catch(e) { alert('‚ùå Erreur: ' + (e.message||e)); }
};

// =====================================================================
// PAGE: USER MANAGEMENT (Super Admin)
// =====================================================================

function renderUserManagement() {
  if (!isSuperAdmin()) {
    return '<div class="card"><div class="card-body"><div class="empty"><div class="empty-icon">üîí</div><div class="empty-title">Acc√®s Super Admin requis</div></div></div></div>';
  }

  var h = '';

  // Create user form
  h += '<div class="card"><div class="card-header">‚ûï Cr√©er un utilisateur</div><div class="card-body"><form onsubmit="handleCreateUser(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Nom complet <span class="req">*</span></label><input type="text" class="form-input" id="nuName" required placeholder="Jean Dupont"></div>';
  h += '<div class="form-group"><label class="form-label">Email <span class="req">*</span></label><input type="email" class="form-input" id="nuEmail" required placeholder="jean@hotel.com"></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Mot de passe <span class="req">*</span></label><input type="text" class="form-input" id="nuPass" required value="Haccp2026!"></div>';
  h += '<div class="form-group"><label class="form-label">R√¥le global</label><select class="form-select" id="nuRole"><option value="employee">üë∑ Employ√©</option><option value="manager">üëî G√©rant</option><option value="super_admin">üëë Super Admin</option></select></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Assigner √† un site</label><select class="form-select" id="nuSite"><option value="">‚Äî Aucun site ‚Äî</option>';
  S.sites.forEach(function(s) { h += '<option value="' + s.id + '">' + esc(s.name) + '</option>'; });
  h += '</select></div>';
  h += '<div class="form-group"><label class="form-label">R√¥le sur le site</label><select class="form-select" id="nuSiteRole"><option value="employee">Employ√©</option><option value="manager">G√©rant</option><option value="admin">Administrateur</option></select></div></div>';
  h += '<div style="background:var(--primary-light);padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px"><strong>üí°</strong> L\'utilisateur pourra se connecter directement avec ces identifiants.</div>';
  h += '<button type="submit" class="btn btn-success btn-lg">‚úì Cr√©er l\'utilisateur</button></form></div></div>';

  // User list with access details
  h += '<div class="card"><div class="card-header">üë• Tous les utilisateurs</div><div class="card-body" id="userListContainer"><div style="text-align:center;padding:20px"><div class="loading"></div></div></div></div>';

  // Auto-load users
  setTimeout(function() { loadAndDisplayUsersDetailed(); }, 50);

  return h;
}

async function loadAndDisplayUsersDetailed() {
  var container = $('userListContainer');
  if (!container) return;

  var users = await loadAllUsers();
  // Charger toutes les assignations
  var allAssignments = [];
  try {
    var r = await sb.from('user_sites').select('*, sites(name)');
    allAssignments = r.data || [];
  } catch(e) { console.error(e); }

  var html = '';
  if (users.length === 0) {
    html = '<div class="empty"><div class="empty-title">Aucun utilisateur</div></div>';
  } else {
    users.forEach(function(u) {
      var roleIcon = {super_admin:'üëë',manager:'üëî',employee:'üë∑'}[u.role] || 'üë§';
      var roleLabel = {super_admin:'Super Admin',manager:'G√©rant',employee:'Employ√©'}[u.role] || u.role;
      var userSites = allAssignments.filter(function(a){return a.user_id===u.id;});

      html += '<div style="background:#fff;border-radius:8px;padding:16px;margin-bottom:12px;border:1px solid var(--gray-border)">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
      html += '<div><strong>' + roleIcon + ' ' + esc(u.full_name||'‚Äî') + '</strong><span style="color:var(--gray);font-size:13px;margin-left:8px">' + esc(u.email) + '</span></div>';
      html += '<div style="display:flex;gap:6px;align-items:center">';
      html += '<select onchange="changeGlobalRole(\'' + u.id + '\',this.value)" style="padding:4px 8px;border-radius:4px;border:1px solid #ddd;font-size:13px">';
      html += '<option value="employee"' + (u.role==='employee'?' selected':'') + '>üë∑ Employ√©</option>';
      html += '<option value="manager"' + (u.role==='manager'?' selected':'') + '>üëî G√©rant</option>';
      html += '<option value="super_admin"' + (u.role==='super_admin'?' selected':'') + '>üëë Super Admin</option>';
      html += '</select></div></div>';

      // Sites assign√©s
      if (userSites.length > 0) {
        html += '<div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px">';
        userSites.forEach(function(us) {
          var siteRoleIcon = {admin:'üîë',manager:'üëî',employee:'üë∑'}[us.site_role]||'';
          html += '<span class="badge badge-blue" style="font-size:12px">' + siteRoleIcon + ' ' + esc(us.sites?us.sites.name:'?') + ' <button onclick="removeSiteAccess(\'' + u.id + '\',\'' + us.site_id + '\');setTimeout(loadAndDisplayUsersDetailed,500)" style="background:none;border:none;cursor:pointer;color:var(--danger);font-weight:bold;margin-left:4px">‚úï</button></span>';
        });
        html += '</div>';
      } else {
        html += '<div style="margin-top:8px;font-size:12px;color:var(--gray)">‚ö†Ô∏è Aucun site assign√©</div>';
      }
      html += '</div>';
    });
  }
  container.innerHTML = html;
}

window.changeGlobalRole = async function(userId, newRole) {
  try {
    await updateUserRole(userId, newRole);
    alert('‚úÖ R√¥le modifi√© !');
    loadAndDisplayUsersDetailed();
  } catch(e) { alert('‚ùå Erreur: ' + (e.message||e)); }
};

async function loadAndDisplayUsers() { loadAndDisplayUsersDetailed(); }

// =====================================================================
// PAGE: PERSONNEL (G√©rants ‚Äî gestion des employ√©s du site)
// =====================================================================

function renderTeam() {
  if (!isManager()) {
    return '<div class="card"><div class="card-body"><div class="empty"><div class="empty-icon">üîí</div><div class="empty-title">Acc√®s r√©serv√© aux g√©rants</div></div></div></div>';
  }

  var site = currentSite();
  if (!site) return '<div class="card"><div class="card-body">Aucun site s√©lectionn√©.</div></div>';

  var h = '';

  // Create employee form
  h += '<div class="card"><div class="card-header">‚ûï Ajouter un membre √† ' + esc(site.name) + '</div><div class="card-body"><form onsubmit="handleTeamAddUser(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Nom complet <span class="req">*</span></label><input type="text" class="form-input" id="teamName" required placeholder="Jean Dupont"></div>';
  h += '<div class="form-group"><label class="form-label">Email <span class="req">*</span></label><input type="email" class="form-input" id="teamEmail" required placeholder="jean@exemple.com"></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Mot de passe provisoire <span class="req">*</span></label><input type="text" class="form-input" id="teamPass" required value="Haccp2026!"></div>';
  h += '<div class="form-group"><label class="form-label">R√¥le sur le site</label><select class="form-select" id="teamRole"><option value="employee">üë∑ Employ√©</option><option value="manager">üëî G√©rant</option></select></div></div>';
  h += '<div style="background:var(--primary-light);padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px"><strong>üí°</strong> L\'utilisateur pourra se connecter directement avec ces identifiants et acc√©dera uniquement √† ce site.</div>';
  h += '<button type="submit" class="btn btn-success btn-lg" id="teamAddBtn">‚úì Ajouter au site</button></form></div></div>';

  // Team list (loaded async)
  h += '<div class="card"><div class="card-header">üë• √âquipe de ' + esc(site.name) + '</div><div class="card-body" id="teamListContainer"><div style="text-align:center;padding:20px"><div class="loading"></div></div></div></div>';

  setTimeout(function() { loadAndRenderTeam(); }, 50);

  return h;
}

async function loadAndRenderTeam() {
  var container = $('teamListContainer');
  if (!container) return;

  var siteUsers = await loadSiteUsers(S.currentSiteId);
  var html = '';

  if (siteUsers.length === 0) {
    html = '<div class="empty"><div class="empty-icon">üë•</div><div class="empty-title">Aucun membre</div><div class="empty-text">Ajoutez des employ√©s avec le formulaire ci-dessus.</div></div>';
  } else {
    html = '<table class="data-table"><thead><tr><th>Nom</th><th>Email</th><th>T√©l√©phone</th><th>R√¥le global</th><th>R√¥le site</th><th>Actions</th></tr></thead><tbody>';
    siteUsers.forEach(function(us) {
      var p = us.profiles;
      if (!p) return;
      var globalRole = {super_admin:'üëë Super Admin',manager:'üëî G√©rant',employee:'üë∑ Employ√©'}[p.role] || p.role;
      html += '<tr>';
      html += '<td><strong>' + esc(p.full_name||'‚Äî') + '</strong></td>';
      html += '<td style="font-size:12px">' + esc(p.email) + '</td>';
      html += '<td style="font-size:12px">' + esc(p.phone||'‚Äî') + '</td>';
      html += '<td>' + globalRole + '</td>';
      html += '<td><select onchange="handleTeamRoleChange(\'' + p.id + '\',this.value)" style="padding:4px 8px;border-radius:4px;border:1px solid #ddd;font-size:13px">';
      html += '<option value="employee"' + (us.site_role==='employee'?' selected':'') + '>üë∑ Employ√©</option>';
      html += '<option value="manager"' + (us.site_role==='manager'?' selected':'') + '>üëî G√©rant</option>';
      if (isSuperAdmin()) html += '<option value="admin"' + (us.site_role==='admin'?' selected':'') + '>üîë Admin</option>';
      html += '</select></td>';
      html += '<td>';
      // Ne pas pouvoir se retirer soi-m√™me
      if (p.id !== S.user.id) {
        html += '<button class="btn btn-danger btn-sm" onclick="handleTeamRemove(\'' + p.id + '\')">Retirer</button>';
      } else {
        html += '<span class="badge badge-blue">Vous</span>';
      }
      html += '</td></tr>';
    });
    html += '</tbody></table>';
  }

  container.innerHTML = html;
}

window.handleTeamAddUser = async function(e) {
  e.preventDefault();
  var btn = $('teamAddBtn');
  var origText = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Cr√©ation...';

  try {
    var email = $('teamEmail').value;
    var name = $('teamName').value;
    var pass = $('teamPass').value;
    var siteRole = $('teamRole').value;

    // V√©rifier si l'utilisateur existe d√©j√†
    var existing = await sb.from('profiles').select('id').eq('email', email).maybeSingle();
    
    var userId;
    if (existing && existing.data) {
      // L'utilisateur existe d√©j√† ‚Äî l'assigner au site
      userId = existing.data.id;
    } else {
      // Cr√©er le compte
      var currentSession = await sb.auth.getSession();
      var savedToken = currentSession.data.session;

      var r = await sb.auth.signUp({
        email: email,
        password: pass,
        options: { data: { full_name: name } }
      });
      if (r.error) throw r.error;
      userId = r.data.user ? r.data.user.id : null;
      if (!userId) throw new Error('Utilisateur non cr√©√©');

      // Restaurer la session du g√©rant
      if (savedToken) {
        await sb.auth.setSession({ access_token: savedToken.access_token, refresh_token: savedToken.refresh_token });
      }

      // Attendre le trigger
      await new Promise(function(resolve) { setTimeout(resolve, 1500); });

      // D√©sactiver must_change_password
      await sb.from('profiles').update({ must_change_password: false, full_name: name }).eq('id', userId);
    }

    // Assigner au site
    await assignUserToSite(userId, S.currentSiteId, siteRole);

    alert('‚úÖ ' + name + ' ajout√©(e) au site !\nüîë Email : ' + email + '\nüîë Mot de passe : ' + pass);
    $('teamName').value = ''; $('teamEmail').value = ''; $('teamPass').value = 'Haccp2026!';
    loadAndRenderTeam();
  } catch(ex) {
    alert('‚ùå Erreur: ' + (ex.message || ex));
  }
  btn.disabled = false; btn.innerHTML = origText;
};

window.handleTeamRoleChange = async function(userId, newRole) {
  try {
    await assignUserToSite(userId, S.currentSiteId, newRole);
    alert('‚úÖ R√¥le modifi√© !');
  } catch(e) { alert('‚ùå Erreur: ' + (e.message||e)); }
};

window.handleTeamRemove = async function(userId) {
  if (!confirm('Retirer cet utilisateur du site ? Il ne pourra plus y acc√©der.')) return;
  try {
    await removeUserFromSite(userId, S.currentSiteId);
    alert('‚úÖ Utilisateur retir√© du site');
    loadAndRenderTeam();
  } catch(e) { alert('‚ùå Erreur: ' + (e.message||e)); }
};

// =====================================================================
// PAGE: MON PROFIL (tous les utilisateurs)
// =====================================================================

function renderProfile() {
  var p = S.profile;
  if (!p) return '';
  var roleLabel = {super_admin:'üëë Super Admin',manager:'üëî G√©rant',employee:'üë∑ Employ√©'}[p.role] || p.role;

  var h = '';

  // Info profil
  h += '<div class="card"><div class="card-header">üë§ Informations personnelles</div><div class="card-body">';
  h += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">';
  h += '<div style="width:64px;height:64px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;color:var(--primary)">' + userInitials() + '</div>';
  h += '<div><div style="font-size:18px;font-weight:700">' + esc(p.full_name) + '</div><div style="color:var(--gray);font-size:14px">' + roleLabel + '</div></div></div>';

  h += '<form onsubmit="handleUpdateProfile(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Nom complet</label><input type="text" class="form-input" id="profName" value="' + esc(p.full_name||'') + '" required></div>';
  h += '<div class="form-group"><label class="form-label">Email <span style="font-size:11px;color:var(--gray)">(non modifiable)</span></label><input type="email" class="form-input" value="' + esc(p.email) + '" disabled style="background:#f3f4f6"></div></div>';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">T√©l√©phone</label><input type="tel" class="form-input" id="profPhone" value="' + esc(p.phone||'') + '" placeholder="06 12 34 56 78"></div>';
  h += '<div class="form-group"><label class="form-label">R√¥le</label><input type="text" class="form-input" value="' + roleLabel + '" disabled style="background:#f3f4f6"></div></div>';
  h += '<button type="submit" class="btn btn-primary">‚úì Enregistrer les modifications</button>';
  h += '</form></div></div>';

  // Changement de mot de passe
  h += '<div class="card"><div class="card-header">üîê Changer le mot de passe</div><div class="card-body">';
  h += '<form onsubmit="handleProfilePassword(event)">';
  h += '<div class="form-row"><div class="form-group"><label class="form-label">Nouveau mot de passe</label><input type="password" class="form-input" id="profPass1" required minlength="6" placeholder="6 caract√®res minimum"></div>';
  h += '<div class="form-group"><label class="form-label">Confirmer le mot de passe</label><input type="password" class="form-input" id="profPass2" required minlength="6" placeholder="Confirmez"></div></div>';
  h += '<div id="profPassError" class="form-error" style="display:none"></div>';
  h += '<button type="submit" class="btn btn-warning">üîê Modifier le mot de passe</button>';
  h += '</form></div></div>';

  // Sites assign√©s (lecture seule pour employ√©)
  if (S.sites.length > 0) {
    h += '<div class="card"><div class="card-header">üè¢ Mes sites</div><div class="card-body">';
    S.sites.forEach(function(s) {
      var typeEmoji = {hotel:'üè®',restaurant:'üçΩÔ∏è',cuisine_centrale:'üè≠',autre:'üè¢'}[s.type] || 'üè¢';
      h += '<div class="list-item"><div class="list-icon" style="background:var(--primary-light)">' + typeEmoji + '</div><div class="list-content"><div class="list-title">' + esc(s.name) + '</div><div class="list-sub">' + (s.address||'') + (s.city ? ', ' + s.city : '') + '</div></div></div>';
    });
    h += '</div></div>';
  }

  // D√©connexion
  h += '<div style="text-align:center;margin-top:20px"><button class="btn btn-danger" onclick="doLogout()">üö™ Se d√©connecter</button></div>';

  return h;
}

window.handleUpdateProfile = async function(e) {
  e.preventDefault();
  try {
    var updates = { full_name: $('profName').value };
    var phone = $('profPhone').value;
    if (phone !== undefined) updates.phone = phone;
    await sb.from('profiles').update(updates).eq('id', S.user.id);
    S.profile.full_name = updates.full_name;
    if (updates.phone) S.profile.phone = updates.phone;
    alert('‚úÖ Profil mis √† jour !');
    render();
  } catch(ex) { alert('‚ùå Erreur: ' + (ex.message||ex)); }
};

window.handleProfilePassword = async function(e) {
  e.preventDefault();
  var p1 = $('profPass1').value, p2 = $('profPass2').value;
  var err = $('profPassError');
  if (p1 !== p2) {
    err.textContent = 'Les mots de passe ne correspondent pas';
    err.style.display = 'block';
    return;
  }
  try {
    await changePassword(p1);
    alert('‚úÖ Mot de passe modifi√© avec succ√®s !');
    $('profPass1').value = ''; $('profPass2').value = '';
    err.style.display = 'none';
  } catch(ex) {
    err.textContent = ex.message || 'Erreur';
    err.style.display = 'block';
  }
};

// =====================================================================
// FORM HANDLERS (all exposed globally)
// =====================================================================

window.showAuthTab = function(tab) {
  var tl = $('tabLogin'), tr = $('tabRegister'), af = $('authForm');
  if (tab === 'login') {
    tl.classList.add('active'); tr.classList.remove('active');
    af.innerHTML = renderLoginForm();
  } else {
    tr.classList.add('active'); tl.classList.remove('active');
    af.innerHTML = renderRegisterForm();
  }
};

window.handleLogin = async function(e) {
  e.preventDefault();
  var btn = $('loginBtn'), err = $('loginError');
  btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Connexion...';
  err.style.display = 'none';
  try {
    await doLogin($('loginEmail').value, $('loginPass').value);
  } catch(ex) {
    err.textContent = ex.message || 'Erreur de connexion';
    err.style.display = 'block';
    btn.disabled = false; btn.textContent = 'Se connecter';
  }
};

window.handleRegister = async function(e) {
  e.preventDefault();
  var btn = $('regBtn'), err = $('regError');
  btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Inscription...';
  err.style.display = 'none';
  try {
    await doRegister($('regEmail').value, $('regPass').value, $('regName').value);
    btn.disabled = false; btn.textContent = 'Cr√©er un compte';
  } catch(ex) {
    err.textContent = ex.message || 'Erreur d\'inscription';
    err.style.display = 'block';
    btn.disabled = false; btn.textContent = 'Cr√©er un compte';
  }
};

window.handleChangePassword = async function(e) {
  e.preventDefault();
  var p1 = $('newPass1').value, p2 = $('newPass2').value, err = $('pwdError');
  if (p1 !== p2) { err.textContent = 'Les mots de passe ne correspondent pas.'; err.style.display = 'block'; return; }
  if (p1.length < 6) { err.textContent = 'Le mot de passe doit faire au moins 6 caract√®res.'; err.style.display = 'block'; return; }
  try {
    await changePassword(p1);
    var overlay = $('pwdOverlay');
    if (overlay) overlay.remove();
  } catch(ex) {
    err.textContent = ex.message || 'Erreur'; err.style.display = 'block';
  }
};

window.handleTempEquip = async function(e) {
  e.preventDefault();
  var eqId = $('tempEq').value, val = $('tempEqVal').value;
  if (!eqId || !val) return;
  var eq = S.siteConfig.equipment.find(function(e){return e.id===eqId;});
  var numVal = parseFloat(val);
  if (eq && (numVal < eq.temp_min || numVal > eq.temp_max)) {
    var action = prompt('‚ö†Ô∏è Temp√©rature non conforme !\nAction corrective effectu√©e :\n(Ex: D√©givrage, Appel SAV, Transfert produits...)');
    if (!action) return;
    await addTemperature('equipment', eqId, numVal, action, '');
  } else {
    await addTemperature('equipment', eqId, numVal, null, null);
  }
  $('tempEq').value = ''; $('tempEqVal').value = '';
};

window.handleTempProd = async function(e) {
  e.preventDefault();
  var prId = $('tempPr').value, val = $('tempPrVal').value;
  if (!prId || !val) return;
  var pr = S.siteConfig.products.find(function(p){return p.id===prId;});
  var numVal = parseFloat(val);
  if (pr && (numVal < pr.temp_min || numVal > pr.temp_max)) {
    var action = prompt('‚ö†Ô∏è Temp√©rature non conforme !\nAction corrective effectu√©e :');
    if (!action) return;
    await addTemperature('product', prId, numVal, action, '');
  } else {
    await addTemperature('product', prId, numVal, null, null);
  }
  $('tempPr').value = ''; $('tempPrVal').value = '';
};

window.handleDlc = async function(e) {
  e.preventDefault();
  await addDlc($('dlcProd').value, $('dlcDate').value, $('dlcLot').value, $('dlcNotes').value);
  $('dlcProd').value = ''; $('dlcDate').value = ''; $('dlcLot').value = ''; $('dlcNotes').value = '';
};

window.handleLot = async function(e) {
  e.preventDefault();
  await addLot($('lotProd').value, $('lotNum').value, $('lotSupp').value, $('lotDlc').value, $('lotNotes').value);
  $('lotProd').value = ''; $('lotNum').value = ''; $('lotSupp').value = ''; $('lotDlc').value = ''; $('lotNotes').value = '';
};

window.handleOrder = async function(e) {
  e.preventDefault();
  await addOrder($('ordProd').value, $('ordQty').value, $('ordUnit').value, $('ordSupp').value, $('ordNotes').value);
  $('ordProd').value = ''; $('ordQty').value = '1'; $('ordNotes').value = '';
};

window.handleConsigne = async function(e) {
  e.preventDefault();
  await addConsigne($('conMsg').value, $('conPrio').value);
  $('conMsg').value = '';
};

window.handleCreateSite = async function(e) {
  e.preventDefault();
  await createSite($('sName').value, $('sType').value, $('sAddr').value, $('sCity').value, $('sPhone').value, $('sEmail').value, $('sAgr').value, $('sResp').value);
  $('sName').value = ''; $('sAddr').value = ''; $('sCity').value = ''; $('sPhone').value = ''; $('sEmail').value = ''; $('sAgr').value = ''; $('sResp').value = '';
};

window.handleCreateUser = async function(e) {
  e.preventDefault();
  var btn = e.target.querySelector('button[type="submit"]');
  var origText = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Cr√©ation en cours...';
  try {
    var email = $('nuEmail').value;
    var role = $('nuRole').value;
    var siteId = $('nuSite').value;
    var siteRole = $('nuSiteRole').value;

    var user = await createUser(email, $('nuPass').value, $('nuName').value, role);

    // Assigner automatiquement au site s√©lectionn√©
    if (user && siteId) {
      await assignUserToSite(user.id, siteId, siteRole);
    }

    var siteName = siteId ? S.sites.find(function(s){return s.id===siteId;}) : null;
    var msg = '‚úÖ Utilisateur ' + email + ' cr√©√© avec succ√®s !';
    if (siteName) msg += '\nüìç Assign√© √† : ' + siteName.name + ' (' + siteRole + ')';
    msg += '\nüîë Mot de passe : ' + $('nuPass').value;
    msg += '\n\nL\'utilisateur peut se connecter directement.';
    alert(msg);

    $('nuName').value = ''; $('nuEmail').value = ''; $('nuPass').value = 'Haccp2026!';
    // Recharger la liste si affich√©e
    if ($('userListContainer')) loadAndDisplayUsers();
  } catch(ex) {
    alert('‚ùå Erreur: ' + (ex.message || ex));
  }
  btn.disabled = false; btn.innerHTML = origText;
};

window.handleAddEquip = async function(e) {
  e.preventDefault();
  await addEquipment($('eqName').value, $('eqType').value, parseFloat($('eqMin').value), parseFloat($('eqMax').value), $('eqEmoji').value);
  $('eqName').value = '';
};

window.handleAddProd = async function(e) {
  e.preventDefault();
  await addProduct($('prName').value, $('prCat').value, parseFloat($('prMin').value), parseFloat($('prMax').value), $('prEmoji').value);
  $('prName').value = '';
};

window.handleAddSupp = async function(e) {
  e.preventDefault();
  await addSupplier($('spName').value, $('spPhone').value, $('spEmail').value);
  $('spName').value = ''; $('spPhone').value = ''; $('spEmail').value = '';
};

window.openSignatureModal = function() {
  openModal(
    '<div class="modal-header"><div class="modal-title">‚úçÔ∏è Signature</div><button class="modal-close" onclick="closeModal()">‚úï</button></div>' +
    '<div class="modal-body"><p style="font-size:13px;color:var(--gray);margin-bottom:12px">Signez avec votre doigt ou votre souris :</p><canvas id="sigCanvas" class="sig-canvas"></canvas></div>' +
    '<div class="modal-footer"><button class="btn btn-ghost" onclick="clearSignature()">üóëÔ∏è Effacer</button><button class="btn btn-primary btn-lg" onclick="saveSignature()">‚úì Confirmer la signature</button></div>'
  );
};

// Expose all global handlers
window.navigate = navigate;
window.toggleSidebar = toggleSidebar;
window.switchSite = switchSite;
window.doLogout = doLogout;

// Dashboard quick actions
window.dashMarkOrdered = async function(id) {
  await updateOrderStatus(id, 'ordered');
};
window.dashMarkReceived = async function(id) {
  await updateOrderStatus(id, 'received');
};
window.markConsigneRead = async function(id) {
  try {
    await sb.from('consignes').update({ priority: 'normal' }).eq('id', id);
    await loadSiteData();
    render();
  } catch(e) { alert('Erreur: ' + (e.message||e)); }
};
window.closeModal = closeModal;
window.openModal = openModal;
window.clearSignature = clearSignature;
window.saveSignature = saveSignature;
window.handlePhotoFor = handlePhotoFor;
window.clearPhotoDlc = clearPhotoDlc;
window.clearPhotoLot = clearPhotoLot;
window.deleteDlc = deleteDlc;
window.updateDlcStatus = updateDlcStatus;
window.deleteLot = deleteLot;
window.addOrder = addOrder;
window.updateOrderStatus = updateOrderStatus;
window.deleteOrder = deleteOrder;
window.deleteConsigne = deleteConsigne;
window.deleteEquipment = deleteEquipment;
window.deleteProduct = deleteProduct;
window.deleteSupplier = deleteSupplier;
window.toggleModule = toggleModule;
window.deleteSite = deleteSite;
window.generateDailyPDF = generateDailyPDF;
window.loadAndDisplayUsers = loadAndDisplayUsers;

// =====================================================================
// INIT
// =====================================================================

(async function() {
  var isAuth = await checkAuth();
  if (isAuth) {
    if (S.profile && S.profile.must_change_password) {
      render();
      renderChangePassword();
    } else {
      await initApp();
    }
  } else {
    S.loading = false;
    render();
  }
})();

</script>
</body>
</html>
